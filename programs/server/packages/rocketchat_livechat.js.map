{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:livechat/livechat.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/startup.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/visitorStatus.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/hooks/externalMessage.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/hooks/leadCapture.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/hooks/markRoomResponded.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/hooks/offlineMessage.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/hooks/RDStation.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/hooks/sendToCRM.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/hooks/sendToFacebook.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/addAgent.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/addManager.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/changeLivechatStatus.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/closeByVisitor.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/closeRoom.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/facebook.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/getCustomFields.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/getAgentData.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/getInitialData.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/getNextAgent.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/loadHistory.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/loginByToken.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/pageVisited.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/registerGuest.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/removeAgent.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/removeCustomField.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/removeDepartment.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/removeManager.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/removeTrigger.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/removeRoom.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/saveAppearance.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/saveCustomField.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/saveDepartment.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/saveInfo.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/saveIntegration.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/saveSurveyFeedback.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/saveTrigger.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/searchAgent.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/sendMessageLivechat.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/sendOfflineMessage.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/setCustomField.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/setDepartmentForVisitor.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/startVideoCall.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/transfer.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/webhookTest.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/takeInquiry.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/returnAsInquiry.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/saveOfficeHours.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/sendTranscript.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/Users.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/Rooms.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/Messages.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatExternalMessage.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatCustomField.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatDepartment.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatDepartmentAgents.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatPageVisited.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatTrigger.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/indexes.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatInquiry.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatOfficeHour.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatVisitors.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/lib/Livechat.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/lib/QueueMethods.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/lib/OfficeClock.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/lib/OmniChannel.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/sendMessageBySMS.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/unclosedLivechats.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/customFields.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/departmentAgents.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/externalMessages.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatAgents.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatAppearance.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatDepartments.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatIntegration.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatManagers.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatRooms.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatQueue.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatTriggers.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/visitorHistory.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/visitorInfo.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/visitorPageVisited.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatInquiries.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatOfficeHours.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/api.js","meteor://ðŸ’»app/packages/rocketchat:livechat/permissions.js","meteor://ðŸ’»app/packages/rocketchat:livechat/messageTypes.js","meteor://ðŸ’»app/packages/rocketchat:livechat/roomType.js","meteor://ðŸ’»app/packages/rocketchat:livechat/config.js","meteor://ðŸ’»app/packages/rocketchat:livechat/imports/server/rest/departments.js","meteor://ðŸ’»app/packages/rocketchat:livechat/imports/server/rest/facebook.js","meteor://ðŸ’»app/packages/rocketchat:livechat/imports/server/rest/messages.js","meteor://ðŸ’»app/packages/rocketchat:livechat/imports/server/rest/sms.js","meteor://ðŸ’»app/packages/rocketchat:livechat/imports/server/rest/users.js","meteor://ðŸ’»app/packages/rocketchat:livechat/imports/server/rest/visitors.js"],"names":["_","module","watch","require","default","v","url","WebApp","Package","webapp","Autoupdate","autoupdate","connectHandlers","use","Meteor","bindEnvironment","req","res","next","reqUrl","parse","pathname","setHeader","domainWhiteList","RocketChat","settings","get","headers","referer","isEmpty","trim","map","split","domain","contains","host","protocol","head","Assets","getText","baseUrl","__meteor_runtime_config__","ROOT_URL_PATH_PREFIX","test","html","autoupdateVersion","JSON","stringify","write","end","startup","roomTypes","setRoomFind","_id","models","Rooms","findLivechatById","authz","addRoomAccessValidator","room","user","t","hasPermission","extraData","token","callbacks","add","Error","TAPi18n","__","lng","language","priority","LOW","UserPresenceEvents","on","session","status","metadata","visitor","LivechatInquiry","updateVisitorStatus","knowledgeEnabled","apiaiKey","apiaiLanguage","key","value","message","editedAt","defer","response","HTTP","post","data","query","msg","lang","sessionId","code","result","fulfillment","speech","LivechatExternalMessage","insert","rid","orig","ts","Date","e","SystemLogger","error","LivechatVisitors","validateMessage","phoneRegexp","RegExp","msgPhones","match","emailRegexp","msgEmails","saveGuestEmailPhoneById","run","waitingResponse","now","setResponseByRoomId","u","username","responseDate","responseTime","getTime","postData","type","sentAt","name","email","Livechat","sendRequest","MEDIUM","sendToRDStation","livechatData","getLivechatRoomGuestInfo","options","token_rdstation","identificador","client_id","nome","phone","telefone","tags","Object","keys","customFields","forEach","field","call","console","msgNavType","sendMessageType","msgType","sendNavHistory","sendToCRM","includeMessages","messages","Messages","findVisibleByRoomId","sort","Array","agentId","navigation","push","saveCRMDataByRoomId","open","OmniChannel","facebook","reply","page","id","text","methods","userId","method","addAgent","addManager","newStatus","statusLivechat","Users","setLivechatStatus","roomId","findOneOpenByVisitorToken","getVisitorByToken","closeRoom","comment","findOneById","usernames","indexOf","action","enabled","hasToken","enable","success","updateById","disable","listPages","subscribe","unsubscribe","LivechatCustomField","find","fetch","check","String","servedBy","getAgentInfo","visitorToken","info","title","color","registrationForm","triggers","departments","allowSwitchingDepartments","online","offlineColor","offlineMessage","offlineSuccessMessage","offlineUnavailableMessage","displayOfflineForm","videoCall","conversationFinishedMessage","nameFieldRegistrationForm","emailFieldRegistrationForm","findOpenByVisitorToken","fields","cl","length","visitorEmails","initSettings","getInitSettings","Livechat_title","Livechat_title_color","Livechat_enabled","Livechat_registration_form","offlineTitle","Livechat_offline_title","Livechat_offline_title_color","Livechat_offline_message","Livechat_offline_success_message","Livechat_offline_form_unavailable","Livechat_display_offline_form","Language","Livechat_videocall_enabled","Jitsi_Enabled","transcript","Livechat_enable_transcript","transcriptMessage","Livechat_transcript_message","Livechat_conversation_finished_message","Livechat_name_field_registration_form","Livechat_email_field_registration_form","agentData","LivechatTrigger","findEnabled","trigger","pick","LivechatDepartment","findEnabledWithAgents","department","Livechat_allow_switching_departments","findOnlineAgents","count","requireDeparment","getRequiredDepartment","agent","getNextAgent","limit","ls","loadMessageHistory","pageInfo","savePageHistory","registerGuest","keepHistoryForToken","removeAgent","customField","removeById","removeDepartment","removeManager","triggerId","removeByRoomId","Subscriptions","validSettings","valid","every","setting","customFieldData","Match","ObjectIncluding","label","scope","visibility","createOrUpdateCustomField","departmentData","departmentAgents","saveDepartment","guestData","roomData","Optional","topic","ret","saveGuest","saveRoomInfo","s","values","visitorRoom","formData","undefined","updateData","item","updateSurveyFeedbackById","Maybe","description","Boolean","conditions","actions","isString","findOneByUsername","sendMessageLivechat","guest","sendMessage","dns","header","placeholders","replace","footer","fromEmail","emailDomain","substr","lastIndexOf","wrapAsync","resolveMx","Email","send","to","from","replyTo","subject","substring","DDPRateLimiter","addRule","connectionId","overwrite","updateLivechatDataByToken","setDepartmentForGuest","Random","getRoom","jitsiTimeout","createWithTypeRoomIdMessageAndUser","actionLinks","icon","i18nLabel","method_id","params","jitsiRoom","transferData","departmentId","hasRole","transfer","postCatchError","resolve","err","unblock","sampleData","createdAt","lastMessageAt","productId","ip","browser","os","customerId","log","statusCode","inquiryId","inquiry","subscriptionData","alert","unread","userMentions","groupMentions","desktopNotifications","mobilePushNotifications","emailNotifications","changeAgentByRoomId","takeInquiry","createCommandWithRoomIdAndUser","stream","emit","removeUsernameById","findOne","openInquiry","day","start","finish","LivechatOfficeHour","updateHours","moment","userLanguage","findVisibleByRoomIdNotContainingTypes","author","datetime","locale","format","singleMessage","emailSettings","setOperator","operator","update","$set","$exists","$ne","roles","findOneOnlineAgentByUsername","findAgents","findOnlineUserFromList","userList","$in","concat","collectionObj","model","rawCollection","findAndModify","livechatCount","$inc","closeOffice","self","openOffice","emails","surveyFeedback","findLivechat","filter","offset","extend","updateLivechatRoomCount","settingsRaw","Settings","findByVisitorToken","findByVisitorId","visitorId","responseBy","$unset","closeByRoomId","closeInfo","closer","closedBy","closedAt","chatDuration","findOpenByAgent","newAgent","crmData","expireAt","multi","setRoomIdByToken","_Base","constructor","isClient","_initModel","findByRoomId","record","remove","tryEnsureIndex","numAgents","findByDepartmentId","createOrUpdateDepartment","showOnRegistration","agents","savedAgents","pluck","LivechatDepartmentAgents","agentsToSave","difference","removeByDepartmentIdAndAgentId","saveAgent","parseInt","order","$gt","upsert","getNextAgentForDepartment","onlineUsers","onlineUsernames","getOnlineForDepartment","depAgents","findUsersInQueue","usersList","replaceUsernameOfAgentByUserId","LivechatPageVisited","sparse","expireAfterSeconds","saveByToken","keepHistoryMiliseconds","findByToken","removeAll","findById","getStatus","newStart","newFinish","newOpen","isNowWithinHours","currentTime","utc","todaysOfficeHours","isBefore","isBetween","isOpeningTime","isSame","isClosingTime","findVisitorByToken","findOneVisitorByPhone","getNextVisitorUsername","saveGuestById","setData","unsetData","address","phoneNumber","findOneGuestByEmailAddress","emailAddress","escapeRegExp","phones","$addToSet","saveEmail","$each","savePhone","exportDefault","UAParser","historyMonitorType","logger","Logger","sections","webhook","i","queryString","getAgents","getOnlineAgents","onlineRequired","dept","onlineAgents","roomInfo","newRoom","routingMethod","QueueMethods","alias","showConnecting","updateUser","existingUser","userData","connection","userAgent","httpHeaders","clientAddress","number","users","closeData","groupable","hideByRoomIdAndUserId","findNotHiddenPublic","setTopicAndTagsById","setFnameById","updateDisplayNameByRoomId","closeOpenChats","forwardOpenChats","change","pageTitle","pageUrl","location","href","_hidden","createNavigationHistoryWithRoomIdMessageAndUser","without","removeByRoomIdAndUserId","createUserLeaveWithRoomIdAndUser","createUserJoinWithRoomIdAndUser","callback","trying","warn","setTimeout","ua","setUA","fname","lm","getOS","version","getBrowser","addUserRoles","removeUserFromRoles","Streamer","allowRead","msgs","agentIds","setInterval","gatewayURL","pageId","SMS","sms","SMSService","getService","agentsHandler","monitorAgents","actionTimeout","queue","clearTimeout","exists","runAgentLeaveAction","observeChanges","added","changed","removed","stop","UserPresenceMonitor","onSetUserStatus","publish","handle","getUsersInRole","ready","onStop","findByIds","$gte","setDate","getDate","setSeconds","getSeconds","$lte","handleDepts","findByRoomIdAndType","Roles","createOrUpdate","Permissions","MessageTypes","registerType","system","history","register","instance","tabBar","isServer","Notifications","notifyRoom","setHiddenById","RoomSettingsEnum","RoomTypeConfig","RoomTypeRouteConfig","UiTextContext","LivechatRoomRoute","path","openRoom","link","sub","LivechatRoomType","identifier","route","notSubscribedTpl","template","findRoom","ChatRoom","roomName","condition","hasAllPermission","canSendMessage","getUserStatus","Session","allowRoomSettingChange","JOIN_CODE","getUiText","context","HIDE_WARNING","LEAVE_WARNING","addGroup","group","public","editor","allowedTypes","section","i18nDescription","enableQuery","API","v1","addRoute","authRequired","unauthorized","bodyParams","failure","urlParams","put","delete","crypto","attachments","request","signature","createHmac","body","digest","mid","rooms","first_name","last_name","sucess","sentMessages","sentMessage","service","media","curr","attachment","message_link","contentType","image_url","video_url","audio_url","extra","fromCountry","fromState","fromCity","role"],"mappings":"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","file":"/packages/rocketchat_livechat.js","sourcesContent":["/* globals WebApp:true */\nimport _ from 'underscore';\nimport url from 'url';\n\nWebApp = Package.webapp.WebApp;\nconst Autoupdate = Package.autoupdate.Autoupdate;\n\nWebApp.connectHandlers.use('/livechat', Meteor.bindEnvironment((req, res, next) => {\n\tconst reqUrl = url.parse(req.url);\n\tif (reqUrl.pathname !== '/') {\n\t\treturn next();\n\t}\n\tres.setHeader('content-type', 'text/html; charset=utf-8');\n\n\tlet domainWhiteList = RocketChat.settings.get('Livechat_AllowedDomainsList');\n\tif (req.headers.referer && !_.isEmpty(domainWhiteList.trim())) {\n\t\tdomainWhiteList = _.map(domainWhiteList.split(','), function(domain) {\n\t\t\treturn domain.trim();\n\t\t});\n\n\t\tconst referer = url.parse(req.headers.referer);\n\t\tif (!_.contains(domainWhiteList, referer.host)) {\n\t\t\tres.setHeader('X-FRAME-OPTIONS', 'DENY');\n\t\t\treturn next();\n\t\t}\n\n\t\tres.setHeader('X-FRAME-OPTIONS', `ALLOW-FROM ${ referer.protocol }//${ referer.host }`);\n\t}\n\n\tconst head = Assets.getText('public/head.html');\n\n\tlet baseUrl;\n\tif (__meteor_runtime_config__.ROOT_URL_PATH_PREFIX && __meteor_runtime_config__.ROOT_URL_PATH_PREFIX.trim() !== '') {\n\t\tbaseUrl = __meteor_runtime_config__.ROOT_URL_PATH_PREFIX;\n\t} else {\n\t\tbaseUrl = '/';\n\t}\n\tif (/\\/$/.test(baseUrl) === false) {\n\t\tbaseUrl += '/';\n\t}\n\n\tconst html = `<html>\n\t\t<head>\n\t\t\t<link rel=\"stylesheet\" type=\"text/css\" class=\"__meteor-css__\" href=\"${ baseUrl }livechat/livechat.css?_dc=${ Autoupdate.autoupdateVersion }\">\n\t\t\t<script type=\"text/javascript\">\n\t\t\t\t__meteor_runtime_config__ = ${ JSON.stringify(__meteor_runtime_config__) };\n\t\t\t</script>\n\n\t\t\t<base href=\"${ baseUrl }\">\n\n\t\t\t${ head }\n\t\t</head>\n\t\t<body>\n\t\t\t<script type=\"text/javascript\" src=\"${ baseUrl }livechat/livechat.js?_dc=${ Autoupdate.autoupdateVersion }\"></script>\n\t\t</body>\n\t</html>`;\n\n\tres.write(html);\n\tres.end();\n}));\n","Meteor.startup(() => {\n\tRocketChat.roomTypes.setRoomFind('l', (_id) => {\n\t\treturn RocketChat.models.Rooms.findLivechatById(_id);\n\t});\n\n\tRocketChat.authz.addRoomAccessValidator(function(room, user) {\n\t\treturn room.t === 'l' && user && RocketChat.authz.hasPermission(user._id, 'view-livechat-rooms');\n\t});\n\n\tRocketChat.authz.addRoomAccessValidator(function(room, user, extraData) {\n\t\treturn room.t === 'l' && extraData && extraData.token && room.v && room.v.token === extraData.token;\n\t});\n\n\tRocketChat.callbacks.add('beforeLeaveRoom', function(user, room) {\n\t\tif (room.t !== 'l') {\n\t\t\treturn user;\n\t\t}\n\t\tthrow new Meteor.Error(TAPi18n.__('You_cant_leave_a_livechat_room_Please_use_the_close_button', {\n\t\t\tlng: user.language || RocketChat.settings.get('language') || 'en'\n\t\t}));\n\t}, RocketChat.callbacks.priority.LOW, 'cant-leave-room');\n});\n","/* globals UserPresenceEvents */\nMeteor.startup(() => {\n\tUserPresenceEvents.on('setStatus', (session, status, metadata) => {\n\t\tif (metadata && metadata.visitor) {\n\t\t\tRocketChat.models.LivechatInquiry.updateVisitorStatus(metadata.visitor, status);\n\t\t\tRocketChat.models.Rooms.updateVisitorStatus(metadata.visitor, status);\n\t\t}\n\t});\n});\n","/* globals HTTP, SystemLogger */\nimport _ from 'underscore';\n\nlet knowledgeEnabled = false;\nlet apiaiKey = '';\nlet apiaiLanguage = 'en';\nRocketChat.settings.get('Livechat_Knowledge_Enabled', function(key, value) {\n\tknowledgeEnabled = value;\n});\nRocketChat.settings.get('Livechat_Knowledge_Apiai_Key', function(key, value) {\n\tapiaiKey = value;\n});\nRocketChat.settings.get('Livechat_Knowledge_Apiai_Language', function(key, value) {\n\tapiaiLanguage = value;\n});\n\nRocketChat.callbacks.add('afterSaveMessage', function(message, room) {\n\t// skips this callback if the message was edited\n\tif (!message || message.editedAt) {\n\t\treturn message;\n\t}\n\n\tif (!knowledgeEnabled) {\n\t\treturn message;\n\t}\n\n\tif (!(typeof room.t !== 'undefined' && room.t === 'l' && room.v && room.v.token)) {\n\t\treturn message;\n\t}\n\n\t// if the message hasn't a token, it was not sent by the visitor, so ignore it\n\tif (!message.token) {\n\t\treturn message;\n\t}\n\n\tMeteor.defer(() => {\n\t\ttry {\n\t\t\tconst response = HTTP.post('https://api.api.ai/api/query?v=20150910', {\n\t\t\t\tdata: {\n\t\t\t\t\tquery: message.msg,\n\t\t\t\t\tlang: apiaiLanguage,\n\t\t\t\t\tsessionId: room._id\n\t\t\t\t},\n\t\t\t\theaders: {\n\t\t\t\t\t'Content-Type': 'application/json; charset=utf-8',\n\t\t\t\t\t'Authorization': `Bearer ${ apiaiKey }`\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tif (response.data && response.data.status.code === 200 && !_.isEmpty(response.data.result.fulfillment.speech)) {\n\t\t\t\tRocketChat.models.LivechatExternalMessage.insert({\n\t\t\t\t\trid: message.rid,\n\t\t\t\t\tmsg: response.data.result.fulfillment.speech,\n\t\t\t\t\torig: message._id,\n\t\t\t\t\tts: new Date()\n\t\t\t\t});\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tSystemLogger.error('Error using Api.ai ->', e);\n\t\t}\n\t});\n\n\treturn message;\n}, RocketChat.callbacks.priority.LOW, 'externalWebHook');\n","import LivechatVisitors from '../../server/models/LivechatVisitors';\n\nfunction validateMessage(message, room) {\n\t// skips this callback if the message was edited\n\tif (message.editedAt) {\n\t\treturn false;\n\t}\n\n\t// message valid only if it is a livechat room\n\tif (!(typeof room.t !== 'undefined' && room.t === 'l' && room.v && room.v.token)) {\n\t\treturn false;\n\t}\n\n\t// if the message hasn't a token, it was NOT sent from the visitor, so ignore it\n\tif (!message.token) {\n\t\treturn false;\n\t}\n\n\t// if the message has a type means it is a special message (like the closing comment), so skips\n\tif (message.t) {\n\t\treturn false;\n\t}\n\n\treturn true;\n}\n\nRocketChat.callbacks.add('afterSaveMessage', function(message, room) {\n\tif (!validateMessage(message, room)) {\n\t\treturn message;\n\t}\n\n\tconst phoneRegexp = new RegExp(RocketChat.settings.get('Livechat_lead_phone_regex'), 'g');\n\tconst msgPhones = message.msg.match(phoneRegexp);\n\n\tconst emailRegexp = new RegExp(RocketChat.settings.get('Livechat_lead_email_regex'), 'gi');\n\tconst msgEmails = message.msg.match(emailRegexp);\n\n\tif (msgEmails || msgPhones) {\n\t\tLivechatVisitors.saveGuestEmailPhoneById(room.v._id, msgEmails, msgPhones);\n\n\t\tRocketChat.callbacks.run('livechat.leadCapture', room);\n\t}\n\n\treturn message;\n}, RocketChat.callbacks.priority.LOW, 'leadCapture');\n","RocketChat.callbacks.add('afterSaveMessage', function(message, room) {\n\t// skips this callback if the message was edited\n\tif (!message || message.editedAt) {\n\t\treturn message;\n\t}\n\n\t// check if room is yet awaiting for response\n\tif (!(typeof room.t !== 'undefined' && room.t === 'l' && room.waitingResponse)) {\n\t\treturn message;\n\t}\n\n\t// if the message has a token, it was sent by the visitor, so ignore it\n\tif (message.token) {\n\t\treturn message;\n\t}\n\n\tMeteor.defer(() => {\n\t\tconst now = new Date();\n\t\tRocketChat.models.Rooms.setResponseByRoomId(room._id, {\n\t\t\tuser: {\n\t\t\t\t_id: message.u._id,\n\t\t\t\tusername: message.u.username\n\t\t\t},\n\t\t\tresponseDate: now,\n\t\t\tresponseTime: (now.getTime() - room.ts) / 1000\n\t\t});\n\t});\n\n\treturn message;\n}, RocketChat.callbacks.priority.LOW, 'markRoomResponded');\n","RocketChat.callbacks.add('livechat.offlineMessage', (data) => {\n\tif (!RocketChat.settings.get('Livechat_webhook_on_offline_msg')) {\n\t\treturn data;\n\t}\n\n\tconst postData = {\n\t\ttype: 'LivechatOfflineMessage',\n\t\tsentAt: new Date(),\n\t\tvisitor: {\n\t\t\tname: data.name,\n\t\t\temail: data.email\n\t\t},\n\t\tmessage: data.message\n\t};\n\n\tRocketChat.Livechat.sendRequest(postData);\n}, RocketChat.callbacks.priority.MEDIUM, 'livechat-send-email-offline-message');\n","function sendToRDStation(room) {\n\tif (!RocketChat.settings.get('Livechat_RDStation_Token')) {\n\t\treturn room;\n\t}\n\n\tconst livechatData = RocketChat.Livechat.getLivechatRoomGuestInfo(room);\n\n\tif (!livechatData.visitor.email) {\n\t\treturn room;\n\t}\n\n\tconst options = {\n\t\theaders: {\n\t\t\t'Content-Type': 'application/json'\n\t\t},\n\t\tdata: {\n\t\t\ttoken_rdstation: RocketChat.settings.get('Livechat_RDStation_Token'),\n\t\t\tidentificador: 'rocketchat-livechat',\n\t\t\tclient_id: livechatData.visitor._id,\n\t\t\temail: livechatData.visitor.email\n\t\t}\n\t};\n\n\toptions.data.nome = livechatData.visitor.name || livechatData.visitor.username;\n\n\tif (livechatData.visitor.phone) {\n\t\toptions.data.telefone = livechatData.visitor.phone;\n\t}\n\n\tif (livechatData.tags) {\n\t\toptions.data.tags = livechatData.tags;\n\t}\n\n\tObject.keys(livechatData.customFields || {}).forEach(field => {\n\t\toptions.data[field] = livechatData.customFields[field];\n\t});\n\n\tObject.keys(livechatData.visitor.customFields || {}).forEach(field => {\n\t\toptions.data[field] = livechatData.visitor.customFields[field];\n\t});\n\n\ttry {\n\t\tHTTP.call('POST', 'https://www.rdstation.com.br/api/1.3/conversions', options);\n\t} catch (e) {\n\t\tconsole.error('Error sending lead to RD Station ->', e);\n\t}\n\n\treturn room;\n}\n\nRocketChat.callbacks.add('livechat.closeRoom', sendToRDStation, RocketChat.callbacks.priority.MEDIUM, 'livechat-rd-station-close-room');\n\nRocketChat.callbacks.add('livechat.saveInfo', sendToRDStation, RocketChat.callbacks.priority.MEDIUM, 'livechat-rd-station-save-info');\n","const msgNavType = 'livechat_navigation_history';\n\nconst sendMessageType = (msgType) => {\n\tconst sendNavHistory = RocketChat.settings.get('Livechat_Visitor_navigation_as_a_message') && RocketChat.settings.get('Send_visitor_navigation_history_livechat_webhook_request');\n\n\treturn sendNavHistory && msgType === msgNavType;\n};\n\nfunction sendToCRM(type, room, includeMessages = true) {\n\tconst postData = RocketChat.Livechat.getLivechatRoomGuestInfo(room);\n\n\tpostData.type = type;\n\n\tpostData.messages = [];\n\n\tlet messages;\n\tif (typeof includeMessages === 'boolean' && includeMessages) {\n\t\tmessages = RocketChat.models.Messages.findVisibleByRoomId(room._id, { sort: { ts: 1 } });\n\t} else if (includeMessages instanceof Array) {\n\t\tmessages = includeMessages;\n\t}\n\n\tif (messages) {\n\t\tmessages.forEach((message) => {\n\t\t\tif (message.t && !sendMessageType(message.t)) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst msg = {\n\t\t\t\t_id: message._id,\n\t\t\t\tusername: message.u.username,\n\t\t\t\tmsg: message.msg,\n\t\t\t\tts: message.ts,\n\t\t\t\teditedAt: message.editedAt\n\t\t\t};\n\n\t\t\tif (message.u.username !== postData.visitor.username) {\n\t\t\t\tmsg.agentId = message.u._id;\n\t\t\t}\n\n\t\t\tif (message.t === msgNavType) {\n\t\t\t\tmsg.navigation = message.navigation;\n\t\t\t}\n\n\t\t\tpostData.messages.push(msg);\n\t\t});\n\t}\n\n\tconst response = RocketChat.Livechat.sendRequest(postData);\n\n\tif (response && response.data && response.data.data) {\n\t\tRocketChat.models.Rooms.saveCRMDataByRoomId(room._id, response.data.data);\n\t}\n\n\treturn room;\n}\n\nRocketChat.callbacks.add('livechat.closeRoom', (room) => {\n\tif (!RocketChat.settings.get('Livechat_webhook_on_close')) {\n\t\treturn room;\n\t}\n\n\treturn sendToCRM('LivechatSession', room);\n}, RocketChat.callbacks.priority.MEDIUM, 'livechat-send-crm-close-room');\n\nRocketChat.callbacks.add('livechat.saveInfo', (room) => {\n\t// Do not send to CRM if the chat is still open\n\tif (room.open) {\n\t\treturn room;\n\t}\n\n\treturn sendToCRM('LivechatEdit', room);\n}, RocketChat.callbacks.priority.MEDIUM, 'livechat-send-crm-save-info');\n\nRocketChat.callbacks.add('afterSaveMessage', function(message, room) {\n\t// only call webhook if it is a livechat room\n\tif (room.t !== 'l' || room.v == null || room.v.token == null) {\n\t\treturn message;\n\t}\n\n\t// if the message has a token, it was sent from the visitor\n\t// if not, it was sent from the agent\n\tif (message.token) {\n\t\tif (!RocketChat.settings.get('Livechat_webhook_on_visitor_message')) {\n\t\t\treturn message;\n\t\t}\n\t} else if (!RocketChat.settings.get('Livechat_webhook_on_agent_message')) {\n\t\treturn message;\n\t}\n\t// if the message has a type means it is a special message (like the closing comment), so skips\n\t// unless the settings that handle with visitor navigation history are enabled\n\tif (message.t && !sendMessageType(message.t)) {\n\t\treturn message;\n\t}\n\n\tsendToCRM('Message', room, [message]);\n\treturn message;\n}, RocketChat.callbacks.priority.MEDIUM, 'livechat-send-crm-message');\n\nRocketChat.callbacks.add('livechat.leadCapture', (room) => {\n\tif (!RocketChat.settings.get('Livechat_webhook_on_capture')) {\n\t\treturn room;\n\t}\n\treturn sendToCRM('LeadCapture', room, false);\n}, RocketChat.callbacks.priority.MEDIUM, 'livechat-send-crm-lead-capture');\n","import OmniChannel from '../lib/OmniChannel';\n\nRocketChat.callbacks.add('afterSaveMessage', function(message, room) {\n\t// skips this callback if the message was edited\n\tif (message.editedAt) {\n\t\treturn message;\n\t}\n\n\tif (!RocketChat.settings.get('Livechat_Facebook_Enabled') || !RocketChat.settings.get('Livechat_Facebook_API_Key')) {\n\t\treturn message;\n\t}\n\n\t// only send the sms by SMS if it is a livechat room with SMS set to true\n\tif (!(typeof room.t !== 'undefined' && room.t === 'l' && room.facebook && room.v && room.v.token)) {\n\t\treturn message;\n\t}\n\n\t// if the message has a token, it was sent from the visitor, so ignore it\n\tif (message.token) {\n\t\treturn message;\n\t}\n\n\t// if the message has a type means it is a special message (like the closing comment), so skips\n\tif (message.t) {\n\t\treturn message;\n\t}\n\n\tOmniChannel.reply({\n\t\tpage: room.facebook.page.id,\n\t\ttoken: room.v.token,\n\t\ttext: message.msg\n\t});\n\n\treturn message;\n\n}, RocketChat.callbacks.priority.LOW, 'sendMessageToFacebook');\n","Meteor.methods({\n\t'livechat:addAgent'(username) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:addAgent' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.addAgent(username);\n\t}\n});\n","Meteor.methods({\n\t'livechat:addManager'(username) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:addManager' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.addManager(username);\n\t}\n});\n","Meteor.methods({\n\t'livechat:changeLivechatStatus'() {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:changeLivechatStatus' });\n\t\t}\n\n\t\tconst user = Meteor.user();\n\n\t\tconst newStatus = user.statusLivechat === 'available' ? 'not-available' : 'available';\n\n\t\treturn RocketChat.models.Users.setLivechatStatus(user._id, newStatus);\n\t}\n});\n","import LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.methods({\n\t'livechat:closeByVisitor'({ roomId, token }) {\n\t\tconst room = RocketChat.models.Rooms.findOneOpenByVisitorToken(token, roomId);\n\n\t\tif (!room || !room.open) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst visitor = LivechatVisitors.getVisitorByToken(token);\n\n\t\tconst language = (visitor && visitor.language) || RocketChat.settings.get('language') || 'en';\n\n\t\treturn RocketChat.Livechat.closeRoom({\n\t\t\tvisitor,\n\t\t\troom,\n\t\t\tcomment: TAPi18n.__('Closed_by_visitor', { lng: language })\n\t\t});\n\t}\n});\n","Meteor.methods({\n\t'livechat:closeRoom'(roomId, comment) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'close-livechat-room')) {\n\t\t\tthrow new Meteor.Error('error-not-authorized', 'Not authorized', { method: 'livechat:closeRoom' });\n\t\t}\n\n\t\tconst room = RocketChat.models.Rooms.findOneById(roomId);\n\n\t\tif (!room || room.t !== 'l') {\n\t\t\tthrow new Meteor.Error('room-not-found', 'Room not found', { method: 'livechat:closeRoom' });\n\t\t}\n\n\t\tconst user = Meteor.user();\n\n\t\tif ((!room.usernames || room.usernames.indexOf(user.username) === -1) && !RocketChat.authz.hasPermission(Meteor.userId(), 'close-others-livechat-room')) {\n\t\t\tthrow new Meteor.Error('error-not-authorized', 'Not authorized', { method: 'livechat:closeRoom' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.closeRoom({\n\t\t\tuser,\n\t\t\troom,\n\t\t\tcomment\n\t\t});\n\t}\n});\n","import OmniChannel from '../lib/OmniChannel';\n\nMeteor.methods({\n\t'livechat:facebook'(options) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:addAgent' });\n\t\t}\n\n\t\ttry {\n\t\t\tswitch (options.action) {\n\t\t\t\tcase 'initialState': {\n\t\t\t\t\treturn {\n\t\t\t\t\t\tenabled: RocketChat.settings.get('Livechat_Facebook_Enabled'),\n\t\t\t\t\t\thasToken: !!RocketChat.settings.get('Livechat_Facebook_API_Key')\n\t\t\t\t\t};\n\t\t\t\t}\n\n\t\t\t\tcase 'enable': {\n\t\t\t\t\tconst result = OmniChannel.enable();\n\n\t\t\t\t\tif (!result.success) {\n\t\t\t\t\t\treturn result;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn RocketChat.settings.updateById('Livechat_Facebook_Enabled', true);\n\t\t\t\t}\n\n\t\t\t\tcase 'disable': {\n\t\t\t\t\tOmniChannel.disable();\n\n\t\t\t\t\treturn RocketChat.settings.updateById('Livechat_Facebook_Enabled', false);\n\t\t\t\t}\n\n\t\t\t\tcase 'list-pages': {\n\t\t\t\t\treturn OmniChannel.listPages();\n\t\t\t\t}\n\n\t\t\t\tcase 'subscribe': {\n\t\t\t\t\treturn OmniChannel.subscribe(options.page);\n\t\t\t\t}\n\n\t\t\t\tcase 'unsubscribe': {\n\t\t\t\t\treturn OmniChannel.unsubscribe(options.page);\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tif (e.response && e.response.data && e.response.data.error) {\n\t\t\t\tif (e.response.data.error.error) {\n\t\t\t\t\tthrow new Meteor.Error(e.response.data.error.error, e.response.data.error.message);\n\t\t\t\t}\n\t\t\t\tif (e.response.data.error.response) {\n\t\t\t\t\tthrow new Meteor.Error('integration-error', e.response.data.error.response.error.message);\n\t\t\t\t}\n\t\t\t\tif (e.response.data.error.message) {\n\t\t\t\t\tthrow new Meteor.Error('integration-error', e.response.data.error.message);\n\t\t\t\t}\n\t\t\t}\n\t\t\tconsole.error('Error contacting omni.rocket.chat:', e);\n\t\t\tthrow new Meteor.Error('integration-error', e.error);\n\t\t}\n\t}\n});\n","Meteor.methods({\n\t'livechat:getCustomFields'() {\n\t\treturn RocketChat.models.LivechatCustomField.find().fetch();\n\t}\n});\n","import LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.methods({\n\t'livechat:getAgentData'({ roomId, token }) {\n\t\tcheck(roomId, String);\n\t\tcheck(token, String);\n\n\t\tconst room = RocketChat.models.Rooms.findOneById(roomId);\n\t\tconst visitor = LivechatVisitors.getVisitorByToken(token);\n\n\t\t// allow to only user to send transcripts from their own chats\n\t\tif (!room || room.t !== 'l' || !room.v || room.v.token !== visitor.token) {\n\t\t\tthrow new Meteor.Error('error-invalid-room', 'Invalid room');\n\t\t}\n\n\t\tif (!room.servedBy) {\n\t\t\treturn;\n\t\t}\n\n\t\treturn RocketChat.models.Users.getAgentInfo(room.servedBy._id);\n\t}\n});\n","import _ from 'underscore';\n\nimport LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.methods({\n\t'livechat:getInitialData'(visitorToken) {\n\t\tconst info = {\n\t\t\tenabled: null,\n\t\t\ttitle: null,\n\t\t\tcolor: null,\n\t\t\tregistrationForm: null,\n\t\t\troom: null,\n\t\t\tvisitor: null,\n\t\t\ttriggers: [],\n\t\t\tdepartments: [],\n\t\t\tallowSwitchingDepartments: null,\n\t\t\tonline: true,\n\t\t\tofflineColor: null,\n\t\t\tofflineMessage: null,\n\t\t\tofflineSuccessMessage: null,\n\t\t\tofflineUnavailableMessage: null,\n\t\t\tdisplayOfflineForm: null,\n\t\t\tvideoCall: null,\n\t\t\tconversationFinishedMessage: null,\n\t\t\tnameFieldRegistrationForm: null,\n\t\t\temailFieldRegistrationForm: null\n\t\t};\n\n\t\tconst room = RocketChat.models.Rooms.findOpenByVisitorToken(visitorToken, {\n\t\t\tfields: {\n\t\t\t\tname: 1,\n\t\t\t\tt: 1,\n\t\t\t\tcl: 1,\n\t\t\t\tu: 1,\n\t\t\t\tusernames: 1,\n\t\t\t\tv: 1,\n\t\t\t\tservedBy: 1\n\t\t\t}\n\t\t}).fetch();\n\n\t\tif (room && room.length > 0) {\n\t\t\tinfo.room = room[0];\n\t\t}\n\n\t\tconst visitor = LivechatVisitors.getVisitorByToken(visitorToken, {\n\t\t\tfields: {\n\t\t\t\tname: 1,\n\t\t\t\tusername: 1,\n\t\t\t\tvisitorEmails: 1\n\t\t\t}\n\t\t});\n\n\t\tif (room) {\n\t\t\tinfo.visitor = visitor;\n\t\t}\n\n\t\tconst initSettings = RocketChat.Livechat.getInitSettings();\n\n\t\tinfo.title = initSettings.Livechat_title;\n\t\tinfo.color = initSettings.Livechat_title_color;\n\t\tinfo.enabled = initSettings.Livechat_enabled;\n\t\tinfo.registrationForm = initSettings.Livechat_registration_form;\n\t\tinfo.offlineTitle = initSettings.Livechat_offline_title;\n\t\tinfo.offlineColor = initSettings.Livechat_offline_title_color;\n\t\tinfo.offlineMessage = initSettings.Livechat_offline_message;\n\t\tinfo.offlineSuccessMessage = initSettings.Livechat_offline_success_message;\n\t\tinfo.offlineUnavailableMessage = initSettings.Livechat_offline_form_unavailable;\n\t\tinfo.displayOfflineForm = initSettings.Livechat_display_offline_form;\n\t\tinfo.language = initSettings.Language;\n\t\tinfo.videoCall = initSettings.Livechat_videocall_enabled === true && initSettings.Jitsi_Enabled === true;\n\t\tinfo.transcript = initSettings.Livechat_enable_transcript;\n\t\tinfo.transcriptMessage = initSettings.Livechat_transcript_message;\n\t\tinfo.conversationFinishedMessage = initSettings.Livechat_conversation_finished_message;\n\t\tinfo.nameFieldRegistrationForm = initSettings.Livechat_name_field_registration_form;\n\t\tinfo.emailFieldRegistrationForm = initSettings.Livechat_email_field_registration_form;\n\n\t\tinfo.agentData = room && room[0] && room[0].servedBy && RocketChat.models.Users.getAgentInfo(room[0].servedBy._id);\n\n\t\tRocketChat.models.LivechatTrigger.findEnabled().forEach((trigger) => {\n\t\t\tinfo.triggers.push(_.pick(trigger, '_id', 'actions', 'conditions'));\n\t\t});\n\n\t\tRocketChat.models.LivechatDepartment.findEnabledWithAgents().forEach((department) => {\n\t\t\tinfo.departments.push(department);\n\t\t});\n\t\tinfo.allowSwitchingDepartments = initSettings.Livechat_allow_switching_departments;\n\n\t\tinfo.online = RocketChat.models.Users.findOnlineAgents().count() > 0;\n\n\t\treturn info;\n\t}\n});\n","Meteor.methods({\n\t'livechat:getNextAgent'({ token, department }) {\n\t\tcheck(token, String);\n\n\t\tconst room = RocketChat.models.Rooms.findOpenByVisitorToken(token).fetch();\n\n\t\tif (room && room.length > 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (!department) {\n\t\t\tconst requireDeparment = RocketChat.Livechat.getRequiredDepartment();\n\t\t\tif (requireDeparment) {\n\t\t\t\tdepartment = requireDeparment._id;\n\t\t\t}\n\t\t}\n\n\t\tconst agent = RocketChat.Livechat.getNextAgent(department);\n\t\tif (!agent) {\n\t\t\treturn;\n\t\t}\n\n\t\treturn RocketChat.models.Users.getAgentInfo(agent.agentId);\n\t}\n});\n","import LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.methods({\n\t'livechat:loadHistory'({ token, rid, end, limit = 20, ls}) {\n\t\tconst visitor = LivechatVisitors.getVisitorByToken(token, { fields: { _id: 1 } });\n\n\t\tif (!visitor) {\n\t\t\treturn;\n\t\t}\n\n\t\treturn RocketChat.loadMessageHistory({ userId: visitor._id, rid, end, limit, ls });\n\t}\n});\n","import LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.methods({\n\t'livechat:loginByToken'(token) {\n\t\tconst user = LivechatVisitors.getVisitorByToken(token, { fields: { _id: 1 } });\n\n\t\tif (!user) {\n\t\t\treturn;\n\t\t}\n\n\t\treturn {\n\t\t\t_id: user._id\n\t\t};\n\t}\n});\n","Meteor.methods({\n\t'livechat:pageVisited'(token, room, pageInfo) {\n\t\tRocketChat.Livechat.savePageHistory(token, room, pageInfo);\n\t}\n});\n","import LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.methods({\n\t'livechat:registerGuest'({ token, name, email, department } = {}) {\n\t\tconst userId = RocketChat.Livechat.registerGuest.call(this, {\n\t\t\ttoken,\n\t\t\tname,\n\t\t\temail,\n\t\t\tdepartment\n\t\t});\n\n\t\t// update visited page history to not expire\n\t\tRocketChat.models.Messages.keepHistoryForToken(token);\n\n\t\tconst visitor = LivechatVisitors.getVisitorByToken(token, {\n\t\t\tfields: {\n\t\t\t\tname: 1,\n\t\t\t\tusername: 1,\n\t\t\t\tvisitorEmails: 1\n\t\t\t}\n\t\t});\n\n\t\treturn {\n\t\t\tuserId,\n\t\t\tvisitor\n\t\t};\n\t}\n});\n","Meteor.methods({\n\t'livechat:removeAgent'(username) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:removeAgent' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.removeAgent(username);\n\t}\n});\n","Meteor.methods({\n\t'livechat:removeCustomField'(_id) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:removeCustomField' });\n\t\t}\n\n\t\tcheck(_id, String);\n\n\t\tconst customField = RocketChat.models.LivechatCustomField.findOneById(_id, { fields: { _id: 1 } });\n\n\t\tif (!customField) {\n\t\t\tthrow new Meteor.Error('error-invalid-custom-field', 'Custom field not found', { method: 'livechat:removeCustomField' });\n\t\t}\n\n\t\treturn RocketChat.models.LivechatCustomField.removeById(_id);\n\t}\n});\n","Meteor.methods({\n\t'livechat:removeDepartment'(_id) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:removeDepartment' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.removeDepartment(_id);\n\t}\n});\n","Meteor.methods({\n\t'livechat:removeManager'(username) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:removeManager' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.removeManager(username);\n\t}\n});\n","Meteor.methods({\n\t'livechat:removeTrigger'(triggerId) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:removeTrigger' });\n\t\t}\n\n\t\tcheck(triggerId, String);\n\n\t\treturn RocketChat.models.LivechatTrigger.removeById(triggerId);\n\t}\n});\n","Meteor.methods({\n\t'livechat:removeRoom'(rid) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'remove-closed-livechat-rooms')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:removeRoom' });\n\t\t}\n\n\t\tconst room = RocketChat.models.Rooms.findOneById(rid);\n\n\t\tif (!room) {\n\t\t\tthrow new Meteor.Error('error-invalid-room', 'Invalid room', {\n\t\t\t\tmethod: 'livechat:removeRoom'\n\t\t\t});\n\t\t}\n\n\t\tif (room.t !== 'l') {\n\t\t\tthrow new Meteor.Error('error-this-is-not-a-livechat-room', 'This is not a Livechat room', {\n\t\t\t\tmethod: 'livechat:removeRoom'\n\t\t\t});\n\t\t}\n\n\t\tif (room.open) {\n\t\t\tthrow new Meteor.Error('error-room-is-not-closed', 'Room is not closed', {\n\t\t\t\tmethod: 'livechat:removeRoom'\n\t\t\t});\n\t\t}\n\n\t\tRocketChat.models.Messages.removeByRoomId(rid);\n\t\tRocketChat.models.Subscriptions.removeByRoomId(rid);\n\t\treturn RocketChat.models.Rooms.removeById(rid);\n\t}\n});\n","Meteor.methods({\n\t'livechat:saveAppearance'(settings) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveAppearance' });\n\t\t}\n\n\t\tconst validSettings = [\n\t\t\t'Livechat_title',\n\t\t\t'Livechat_title_color',\n\t\t\t'Livechat_show_agent_email',\n\t\t\t'Livechat_display_offline_form',\n\t\t\t'Livechat_offline_form_unavailable',\n\t\t\t'Livechat_offline_message',\n\t\t\t'Livechat_offline_success_message',\n\t\t\t'Livechat_offline_title',\n\t\t\t'Livechat_offline_title_color',\n\t\t\t'Livechat_offline_email',\n\t\t\t'Livechat_conversation_finished_message',\n\t\t\t'Livechat_registration_form',\n\t\t\t'Livechat_name_field_registration_form',\n\t\t\t'Livechat_email_field_registration_form'\n\t\t];\n\n\t\tconst valid = settings.every((setting) => {\n\t\t\treturn validSettings.indexOf(setting._id) !== -1;\n\t\t});\n\n\t\tif (!valid) {\n\t\t\tthrow new Meteor.Error('invalid-setting');\n\t\t}\n\n\t\tsettings.forEach((setting) => {\n\t\t\tRocketChat.settings.updateById(setting._id, setting.value);\n\t\t});\n\n\t\treturn;\n\t}\n});\n","/* eslint new-cap: [2, {\"capIsNewExceptions\": [\"Match.ObjectIncluding\", \"Match.Optional\"]}] */\n\nMeteor.methods({\n\t'livechat:saveCustomField'(_id, customFieldData) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveCustomField' });\n\t\t}\n\n\t\tif (_id) {\n\t\t\tcheck(_id, String);\n\t\t}\n\n\t\tcheck(customFieldData, Match.ObjectIncluding({ field: String, label: String, scope: String, visibility: String }));\n\n\t\tif (!/^[0-9a-zA-Z-_]+$/.test(customFieldData.field)) {\n\t\t\tthrow new Meteor.Error('error-invalid-custom-field-nmae', 'Invalid custom field name. Use only letters, numbers, hyphens and underscores.', { method: 'livechat:saveCustomField' });\n\t\t}\n\n\t\tif (_id) {\n\t\t\tconst customField = RocketChat.models.LivechatCustomField.findOneById(_id);\n\t\t\tif (!customField) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-custom-field', 'Custom Field Not found', { method: 'livechat:saveCustomField' });\n\t\t\t}\n\t\t}\n\n\t\treturn RocketChat.models.LivechatCustomField.createOrUpdateCustomField(_id, customFieldData.field, customFieldData.label, customFieldData.scope, customFieldData.visibility);\n\t}\n});\n","Meteor.methods({\n\t'livechat:saveDepartment'(_id, departmentData, departmentAgents) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveDepartment' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.saveDepartment(_id, departmentData, departmentAgents);\n\t}\n});\n","/* eslint new-cap: [2, {\"capIsNewExceptions\": [\"Match.ObjectIncluding\", \"Match.Optional\"]}] */\n\nMeteor.methods({\n\t'livechat:saveInfo'(guestData, roomData) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-l-room')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveInfo' });\n\t\t}\n\n\t\tcheck(guestData, Match.ObjectIncluding({\n\t\t\t_id: String,\n\t\t\tname: Match.Optional(String),\n\t\t\temail: Match.Optional(String),\n\t\t\tphone: Match.Optional(String)\n\t\t}));\n\n\t\tcheck(roomData, Match.ObjectIncluding({\n\t\t\t_id: String,\n\t\t\ttopic: Match.Optional(String),\n\t\t\ttags: Match.Optional(String)\n\t\t}));\n\n\t\tconst room = RocketChat.models.Rooms.findOneById(roomData._id, {fields: {t: 1, servedBy: 1}});\n\n\t\tif (room == null || room.t !== 'l') {\n\t\t\tthrow new Meteor.Error('error-invalid-room', 'Invalid room', { method: 'livechat:saveInfo' });\n\t\t}\n\n\t\tif ((!room.servedBy || room.servedBy._id !== Meteor.userId()) && !RocketChat.authz.hasPermission(Meteor.userId(), 'save-others-livechat-room-info')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveInfo' });\n\t\t}\n\n\t\tconst ret = RocketChat.Livechat.saveGuest(guestData) && RocketChat.Livechat.saveRoomInfo(roomData, guestData);\n\n\t\tMeteor.defer(() => {\n\t\t\tRocketChat.callbacks.run('livechat.saveInfo', RocketChat.models.Rooms.findOneById(roomData._id));\n\t\t});\n\n\t\treturn ret;\n\t}\n});\n","import s from 'underscore.string';\n\nMeteor.methods({\n\t'livechat:saveIntegration'(values) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveIntegration' });\n\t\t}\n\n\t\tif (typeof values['Livechat_webhookUrl'] !== 'undefined') {\n\t\t\tRocketChat.settings.updateById('Livechat_webhookUrl', s.trim(values['Livechat_webhookUrl']));\n\t\t}\n\n\t\tif (typeof values['Livechat_secret_token'] !== 'undefined') {\n\t\t\tRocketChat.settings.updateById('Livechat_secret_token', s.trim(values['Livechat_secret_token']));\n\t\t}\n\n\t\tif (typeof values['Livechat_webhook_on_close'] !== 'undefined') {\n\t\t\tRocketChat.settings.updateById('Livechat_webhook_on_close', !!values['Livechat_webhook_on_close']);\n\t\t}\n\n\t\tif (typeof values['Livechat_webhook_on_offline_msg'] !== 'undefined') {\n\t\t\tRocketChat.settings.updateById('Livechat_webhook_on_offline_msg', !!values['Livechat_webhook_on_offline_msg']);\n\t\t}\n\n\t\tif (typeof values['Livechat_webhook_on_visitor_message'] !== 'undefined') {\n\t\t\tRocketChat.settings.updateById('Livechat_webhook_on_visitor_message', !!values['Livechat_webhook_on_visitor_message']);\n\t\t}\n\n\t\tif (typeof values['Livechat_webhook_on_agent_message'] !== 'undefined') {\n\t\t\tRocketChat.settings.updateById('Livechat_webhook_on_agent_message', !!values['Livechat_webhook_on_agent_message']);\n\t\t}\n\n\t\treturn;\n\t}\n});\n","/* eslint new-cap: [2, {\"capIsNewExceptions\": [\"Match.ObjectIncluding\"]}] */\nimport LivechatVisitors from '../models/LivechatVisitors';\nimport _ from 'underscore';\n\nMeteor.methods({\n\t'livechat:saveSurveyFeedback'(visitorToken, visitorRoom, formData) {\n\t\tcheck(visitorToken, String);\n\t\tcheck(visitorRoom, String);\n\t\tcheck(formData, [Match.ObjectIncluding({ name: String, value: String })]);\n\n\t\tconst visitor = LivechatVisitors.getVisitorByToken(visitorToken);\n\t\tconst room = RocketChat.models.Rooms.findOneById(visitorRoom);\n\n\t\tif (visitor !== undefined && room !== undefined && room.v !== undefined && room.v.token === visitor.token) {\n\t\t\tconst updateData = {};\n\t\t\tfor (const item of formData) {\n\t\t\t\tif (_.contains(['satisfaction', 'agentKnowledge', 'agentResposiveness', 'agentFriendliness'], item.name) && _.contains(['1', '2', '3', '4', '5'], item.value)) {\n\t\t\t\t\tupdateData[item.name] = item.value;\n\t\t\t\t} else if (item.name === 'additionalFeedback') {\n\t\t\t\t\tupdateData[item.name] = item.value;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (!_.isEmpty(updateData)) {\n\t\t\t\treturn RocketChat.models.Rooms.updateSurveyFeedbackById(room._id, updateData);\n\t\t\t}\n\t\t}\n\t}\n});\n","Meteor.methods({\n\t'livechat:saveTrigger'(trigger) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveTrigger' });\n\t\t}\n\n\t\tcheck(trigger, {\n\t\t\t_id: Match.Maybe(String),\n\t\t\tname: String,\n\t\t\tdescription: String,\n\t\t\tenabled: Boolean,\n\t\t\tconditions: Array,\n\t\t\tactions: Array\n\t\t});\n\n\t\tif (trigger._id) {\n\t\t\treturn RocketChat.models.LivechatTrigger.updateById(trigger._id, trigger);\n\t\t} else {\n\t\t\treturn RocketChat.models.LivechatTrigger.insert(trigger);\n\t\t}\n\t}\n});\n","import _ from 'underscore';\n\nMeteor.methods({\n\t'livechat:searchAgent'(username) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:searchAgent' });\n\t\t}\n\n\t\tif (!username || !_.isString(username)) {\n\t\t\tthrow new Meteor.Error('error-invalid-arguments', 'Invalid arguments', { method: 'livechat:searchAgent' });\n\t\t}\n\n\t\tconst user = RocketChat.models.Users.findOneByUsername(username, { fields: { _id: 1, username: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'livechat:searchAgent' });\n\t\t}\n\n\t\treturn user;\n\t}\n});\n","import LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.methods({\n\tsendMessageLivechat({ token, _id, rid, msg }, agent) {\n\t\tcheck(token, String);\n\t\tcheck(_id, String);\n\t\tcheck(rid, String);\n\t\tcheck(msg, String);\n\n\t\tcheck(agent, Match.Maybe({\n\t\t\tagentId: String,\n\t\t\tusername: String\n\t\t}));\n\n\t\tconst guest = LivechatVisitors.getVisitorByToken(token, {\n\t\t\tfields: {\n\t\t\t\tname: 1,\n\t\t\t\tusername: 1,\n\t\t\t\tdepartment: 1,\n\t\t\t\ttoken: 1\n\t\t\t}\n\t\t});\n\n\t\tif (!guest) {\n\t\t\tthrow new Meteor.Error('invalid-token');\n\t\t}\n\n\t\treturn RocketChat.Livechat.sendMessage({\n\t\t\tguest,\n\t\t\tmessage: {\n\t\t\t\t_id,\n\t\t\t\trid,\n\t\t\t\tmsg,\n\t\t\t\ttoken\n\t\t\t},\n\t\t\tagent\n\t\t});\n\t}\n});\n","/* globals DDPRateLimiter */\nimport dns from 'dns';\n\nMeteor.methods({\n\t'livechat:sendOfflineMessage'(data) {\n\t\tcheck(data, {\n\t\t\tname: String,\n\t\t\temail: String,\n\t\t\tmessage: String\n\t\t});\n\n\t\tif (!RocketChat.settings.get('Livechat_display_offline_form')) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst header = RocketChat.placeholders.replace(RocketChat.settings.get('Email_Header') || '');\n\t\tconst footer = RocketChat.placeholders.replace(RocketChat.settings.get('Email_Footer') || '');\n\n\t\tconst message = (`${ data.message }`).replace(/([^>\\r\\n]?)(\\r\\n|\\n\\r|\\r|\\n)/g, '$1' + '<br>' + '$2');\n\n\t\tconst html = `\n\t\t\t<h1>New livechat message</h1>\n\t\t\t<p><strong>Visitor name:</strong> ${ data.name }</p>\n\t\t\t<p><strong>Visitor email:</strong> ${ data.email }</p>\n\t\t\t<p><strong>Message:</strong><br>${ message }</p>`;\n\n\t\tlet fromEmail = RocketChat.settings.get('From_Email').match(/\\b[A-Z0-9._%+-]+@(?:[A-Z0-9-]+\\.)+[A-Z]{2,4}\\b/i);\n\n\t\tif (fromEmail) {\n\t\t\tfromEmail = fromEmail[0];\n\t\t} else {\n\t\t\tfromEmail = RocketChat.settings.get('From_Email');\n\t\t}\n\n\t\tif (RocketChat.settings.get('Livechat_validate_offline_email')) {\n\t\t\tconst emailDomain = data.email.substr(data.email.lastIndexOf('@') + 1);\n\n\t\t\ttry {\n\t\t\t\tMeteor.wrapAsync(dns.resolveMx)(emailDomain);\n\t\t\t} catch (e) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-email-address', 'Invalid email address', { method: 'livechat:sendOfflineMessage' });\n\t\t\t}\n\t\t}\n\n\t\tMeteor.defer(() => {\n\t\t\tEmail.send({\n\t\t\t\tto: RocketChat.settings.get('Livechat_offline_email'),\n\t\t\t\tfrom: `${ data.name } - ${ data.email } <${ fromEmail }>`,\n\t\t\t\treplyTo: `${ data.name } <${ data.email }>`,\n\t\t\t\tsubject: `Livechat offline message from ${ data.name }: ${ (`${ data.message }`).substring(0, 20) }`,\n\t\t\t\thtml: header + html + footer\n\t\t\t});\n\t\t});\n\n\t\tMeteor.defer(() => {\n\t\t\tRocketChat.callbacks.run('livechat.offlineMessage', data);\n\t\t});\n\n\t\treturn true;\n\t}\n});\n\nDDPRateLimiter.addRule({\n\ttype: 'method',\n\tname: 'livechat:sendOfflineMessage',\n\tconnectionId() {\n\t\treturn true;\n\t}\n}, 1, 5000);\n","import LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.methods({\n\t'livechat:setCustomField'(token, key, value, overwrite = true) {\n\t\tconst customField = RocketChat.models.LivechatCustomField.findOneById(key);\n\t\tif (customField) {\n\t\t\tif (customField.scope === 'room') {\n\t\t\t\treturn RocketChat.models.Rooms.updateLivechatDataByToken(token, key, value, overwrite);\n\t\t\t} else {\n\t\t\t\t// Save in user\n\t\t\t\treturn LivechatVisitors.updateLivechatDataByToken(token, key, value, overwrite);\n\t\t\t}\n\t\t}\n\n\t\treturn true;\n\t}\n});\n","Meteor.methods({\n\t'livechat:setDepartmentForVisitor'({ token, department } = {}) {\n\t\tRocketChat.Livechat.setDepartmentForGuest.call(this, {\n\t\t\ttoken,\n\t\t\tdepartment\n\t\t});\n\n\t\t// update visited page history to not expire\n\t\tRocketChat.models.Messages.keepHistoryForToken(token);\n\n\t\treturn true;\n\t}\n});\n","/* eslint new-cap: [2, {\"capIsNewExceptions\": [\"MD5\"]}] */\nMeteor.methods({\n\t'livechat:startVideoCall'(roomId) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-not-authorized', 'Not authorized', { method: 'livechat:closeByVisitor' });\n\t\t}\n\n\t\tconst guest = Meteor.user();\n\n\t\tconst message = {\n\t\t\t_id: Random.id(),\n\t\t\trid: roomId || Random.id(),\n\t\t\tmsg: '',\n\t\t\tts: new Date()\n\t\t};\n\n\t\tconst { room } = RocketChat.Livechat.getRoom(guest, message, { jitsiTimeout: new Date(Date.now() + 3600 * 1000) });\n\t\tmessage.rid = room._id;\n\n\t\tRocketChat.models.Messages.createWithTypeRoomIdMessageAndUser('livechat_video_call', room._id, '', guest, {\n\t\t\tactionLinks: [\n\t\t\t\t{ icon: 'icon-videocam', i18nLabel: 'Accept', method_id: 'createLivechatCall', params: '' },\n\t\t\t\t{ icon: 'icon-cancel', i18nLabel: 'Decline', method_id: 'denyLivechatCall', params: '' }\n\t\t\t]\n\t\t});\n\n\t\treturn {\n\t\t\troomId: room._id,\n\t\t\tdomain: RocketChat.settings.get('Jitsi_Domain'),\n\t\t\tjitsiRoom: RocketChat.settings.get('Jitsi_URL_Room_Prefix') + RocketChat.settings.get('uniqueID') + roomId\n\t\t};\n\t}\n});\n\n","/* eslint new-cap: [2, {\"capIsNewExceptions\": [\"Match.Optional\"]}] */\n\nimport LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.methods({\n\t'livechat:transfer'(transferData) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-l-room')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:transfer' });\n\t\t}\n\n\t\tcheck(transferData, {\n\t\t\troomId: String,\n\t\t\tuserId: Match.Optional(String),\n\t\t\tdepartmentId: Match.Optional(String)\n\t\t});\n\n\t\tconst room = RocketChat.models.Rooms.findOneById(transferData.roomId);\n\n\t\tconst guest = LivechatVisitors.findOneById(room.v._id);\n\n\t\tconst user = Meteor.user();\n\n\t\tif (room.usernames.indexOf(user.username) === -1 && !RocketChat.authz.hasRole(Meteor.userId(), 'livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-authorized', 'Not authorized', { method: 'livechat:transfer' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.transfer(room, guest, transferData);\n\t}\n});\n","/* globals HTTP */\nconst postCatchError = Meteor.wrapAsync(function(url, options, resolve) {\n\tHTTP.post(url, options, function(err, res) {\n\t\tif (err) {\n\t\t\tresolve(null, err.response);\n\t\t} else {\n\t\t\tresolve(null, res);\n\t\t}\n\t});\n});\n\nMeteor.methods({\n\t'livechat:webhookTest'() {\n\t\tthis.unblock();\n\n\t\tconst sampleData = {\n\t\t\ttype: 'LivechatSession',\n\t\t\t_id: 'fasd6f5a4sd6f8a4sdf',\n\t\t\tlabel: 'title',\n\t\t\ttopic: 'asiodojf',\n\t\t\tcreatedAt: new Date(),\n\t\t\tlastMessageAt: new Date(),\n\t\t\ttags: [\n\t\t\t\t'tag1',\n\t\t\t\t'tag2',\n\t\t\t\t'tag3'\n\t\t\t],\n\t\t\tcustomFields: {\n\t\t\t\tproductId: '123456'\n\t\t\t},\n\t\t\tvisitor: {\n\t\t\t\t_id: '',\n\t\t\t\tname: 'visitor name',\n\t\t\t\tusername: 'visitor-username',\n\t\t\t\tdepartment: 'department',\n\t\t\t\temail: 'email@address.com',\n\t\t\t\tphone: '192873192873',\n\t\t\t\tip: '123.456.7.89',\n\t\t\t\tbrowser: 'Chrome',\n\t\t\t\tos: 'Linux',\n\t\t\t\tcustomFields: {\n\t\t\t\t\tcustomerId: '123456'\n\t\t\t\t}\n\t\t\t},\n\t\t\tagent: {\n\t\t\t\t_id: 'asdf89as6df8',\n\t\t\t\tusername: 'agent.username',\n\t\t\t\tname: 'Agent Name',\n\t\t\t\temail: 'agent@email.com'\n\t\t\t},\n\t\t\tmessages: [{\n\t\t\t\tusername: 'visitor-username',\n\t\t\t\tmsg: 'message content',\n\t\t\t\tts: new Date()\n\t\t\t}, {\n\t\t\t\tusername: 'agent.username',\n\t\t\t\tagentId: 'asdf89as6df8',\n\t\t\t\tmsg: 'message content from agent',\n\t\t\t\tts: new Date()\n\t\t\t}]\n\t\t};\n\n\t\tconst options = {\n\t\t\theaders: {\n\t\t\t\t'X-RocketChat-Livechat-Token': RocketChat.settings.get('Livechat_secret_token')\n\t\t\t},\n\t\t\tdata: sampleData\n\t\t};\n\n\t\tconst response = postCatchError(RocketChat.settings.get('Livechat_webhookUrl'), options);\n\n\t\tconsole.log('response ->', response);\n\n\t\tif (response && response.statusCode && response.statusCode === 200) {\n\t\t\treturn true;\n\t\t} else {\n\t\t\tthrow new Meteor.Error('error-invalid-webhook-response');\n\t\t}\n\t}\n});\n\n","Meteor.methods({\n\t'livechat:takeInquiry'(inquiryId) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-l-room')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:takeInquiry' });\n\t\t}\n\n\t\tconst inquiry = RocketChat.models.LivechatInquiry.findOneById(inquiryId);\n\n\t\tif (!inquiry || inquiry.status === 'taken') {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Inquiry already taken', { method: 'livechat:takeInquiry' });\n\t\t}\n\n\t\tconst user = RocketChat.models.Users.findOneById(Meteor.userId());\n\n\t\tconst agent = {\n\t\t\tagentId: user._id,\n\t\t\tusername: user.username\n\t\t};\n\n\t\t// add subscription\n\t\tconst subscriptionData = {\n\t\t\trid: inquiry.rid,\n\t\t\tname: inquiry.name,\n\t\t\talert: true,\n\t\t\topen: true,\n\t\t\tunread: 1,\n\t\t\tuserMentions: 1,\n\t\t\tgroupMentions: 0,\n\t\t\tu: {\n\t\t\t\t_id: agent.agentId,\n\t\t\t\tusername: agent.username\n\t\t\t},\n\t\t\tt: 'l',\n\t\t\tdesktopNotifications: 'all',\n\t\t\tmobilePushNotifications: 'all',\n\t\t\temailNotifications: 'all'\n\t\t};\n\t\tRocketChat.models.Subscriptions.insert(subscriptionData);\n\n\t\t// update room\n\t\tconst room = RocketChat.models.Rooms.findOneById(inquiry.rid);\n\n\t\tRocketChat.models.Rooms.changeAgentByRoomId(inquiry.rid, agent);\n\n\t\troom.servedBy = {\n\t\t\t_id: agent.agentId,\n\t\t\tusername: agent.username\n\t\t};\n\n\t\t// mark inquiry as taken\n\t\tRocketChat.models.LivechatInquiry.takeInquiry(inquiry._id);\n\n\t\t// remove sending message from guest widget\n\t\t// dont check if setting is true, because if settingwas switched off inbetween  guest entered pool,\n\t\t// and inquiry being taken, message would not be switched off.\n\t\tRocketChat.models.Messages.createCommandWithRoomIdAndUser('connected', room._id, user);\n\n\t\tRocketChat.Livechat.stream.emit(room._id, {\n\t\t\ttype: 'agentData',\n\t\t\tdata: RocketChat.models.Users.getAgentInfo(agent.agentId)\n\t\t});\n\n\t\t// return room corresponding to inquiry (for redirecting agent to the room route)\n\t\treturn room;\n\t}\n});\n","Meteor.methods({\n\t'livechat:returnAsInquiry'(rid) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-l-room')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveDepartment' });\n\t\t}\n\n\t\t// //delete agent and room subscription\n\t\tRocketChat.models.Subscriptions.removeByRoomId(rid);\n\n\t\t// remove user from room\n\t\tconst username = Meteor.user().username;\n\n\t\tRocketChat.models.Rooms.removeUsernameById(rid, username);\n\n\t\t// find inquiry corresponding to room\n\t\tconst inquiry = RocketChat.models.LivechatInquiry.findOne({rid});\n\n\t\t// mark inquiry as open\n\t\treturn RocketChat.models.LivechatInquiry.openInquiry(inquiry._id);\n\t}\n});\n","Meteor.methods({\n\t'livechat:saveOfficeHours'(day, start, finish, open) {\n\t\tRocketChat.models.LivechatOfficeHour.updateHours(day, start, finish, open);\n\t}\n});\n","/* globals emailSettings, DDPRateLimiter */\n/* Send a transcript of the room converstation to the given email */\nimport moment from 'moment';\n\nimport LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.methods({\n\t'livechat:sendTranscript'(token, rid, email) {\n\t\tcheck(rid, String);\n\t\tcheck(email, String);\n\n\t\tconst room = RocketChat.models.Rooms.findOneById(rid);\n\n\t\tconst visitor = LivechatVisitors.getVisitorByToken(token);\n\t\tconst userLanguage = (visitor && visitor.language) || RocketChat.settings.get('language') || 'en';\n\n\t\t// allow to only user to send transcripts from their own chats\n\t\tif (!room || room.t !== 'l' || !room.v || room.v.token !== token) {\n\t\t\tthrow new Meteor.Error('error-invalid-room', 'Invalid room');\n\t\t}\n\n\t\tconst messages = RocketChat.models.Messages.findVisibleByRoomIdNotContainingTypes(rid, ['livechat_navigation_history'], { sort: { 'ts' : 1 }});\n\t\tconst header = RocketChat.placeholders.replace(RocketChat.settings.get('Email_Header') || '');\n\t\tconst footer = RocketChat.placeholders.replace(RocketChat.settings.get('Email_Footer') || '');\n\n\t\tlet html = '<div> <hr>';\n\t\tmessages.forEach(message => {\n\t\t\tif (message.t && ['command', 'livechat-close', 'livechat_video_call'].indexOf(message.t) !== -1) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tlet author;\n\t\t\tif (message.u._id === visitor._id) {\n\t\t\t\tauthor = TAPi18n.__('You', { lng: userLanguage });\n\t\t\t} else {\n\t\t\t\tauthor = message.u.username;\n\t\t\t}\n\n\t\t\tconst datetime = moment(message.ts).locale(userLanguage).format('LLL');\n\t\t\tconst singleMessage = `\n\t\t\t\t<p><strong>${ author }</strong>  <em>${ datetime }</em></p>\n\t\t\t\t<p>${ message.msg }</p>\n\t\t\t`;\n\t\t\thtml = html + singleMessage;\n\t\t});\n\n\t\thtml = `${ html }</div>`;\n\n\t\tlet fromEmail = RocketChat.settings.get('From_Email').match(/\\b[A-Z0-9._%+-]+@(?:[A-Z0-9-]+\\.)+[A-Z]{2,4}\\b/i);\n\n\t\tif (fromEmail) {\n\t\t\tfromEmail = fromEmail[0];\n\t\t} else {\n\t\t\tfromEmail = RocketChat.settings.get('From_Email');\n\t\t}\n\n\t\temailSettings = {\n\t\t\tto: email,\n\t\t\tfrom: fromEmail,\n\t\t\treplyTo: fromEmail,\n\t\t\tsubject: TAPi18n.__('Transcript_of_your_livechat_conversation', { lng: userLanguage }),\n\t\t\thtml: header + html + footer\n\t\t};\n\n\t\tMeteor.defer(() => {\n\t\t\tEmail.send(emailSettings);\n\t\t});\n\n\t\tMeteor.defer(() => {\n\t\t\tRocketChat.callbacks.run('livechat.sendTranscript', messages, email);\n\t\t});\n\n\t\treturn true;\n\t}\n});\n\nDDPRateLimiter.addRule({\n\ttype: 'method',\n\tname: 'livechat:sendTranscript',\n\tconnectionId() {\n\t\treturn true;\n\t}\n}, 1, 5000);\n","/**\n * Sets an user as (non)operator\n * @param {string} _id - User's _id\n * @param {boolean} operator - Flag to set as operator or not\n */\nRocketChat.models.Users.setOperator = function(_id, operator) {\n\tconst update = {\n\t\t$set: {\n\t\t\toperator\n\t\t}\n\t};\n\n\treturn this.update(_id, update);\n};\n\n/**\n * Gets all online agents\n * @return\n */\nRocketChat.models.Users.findOnlineAgents = function() {\n\tconst query = {\n\t\tstatus: {\n\t\t\t$exists: true,\n\t\t\t$ne: 'offline'\n\t\t},\n\t\tstatusLivechat: 'available',\n\t\troles: 'livechat-agent'\n\t};\n\n\treturn this.find(query);\n};\n\n/**\n * Find an online agent by his username\n * @return\n */\nRocketChat.models.Users.findOneOnlineAgentByUsername = function(username) {\n\tconst query = {\n\t\tusername,\n\t\tstatus: {\n\t\t\t$exists: true,\n\t\t\t$ne: 'offline'\n\t\t},\n\t\tstatusLivechat: 'available',\n\t\troles: 'livechat-agent'\n\t};\n\n\treturn this.findOne(query);\n};\n\n/**\n * Gets all agents\n * @return\n */\nRocketChat.models.Users.findAgents = function() {\n\tconst query = {\n\t\troles: 'livechat-agent'\n\t};\n\n\treturn this.find(query);\n};\n\n/**\n * Find online users from a list\n * @param {array} userList - array of usernames\n * @return\n */\nRocketChat.models.Users.findOnlineUserFromList = function(userList) {\n\tconst query = {\n\t\tstatus: {\n\t\t\t$exists: true,\n\t\t\t$ne: 'offline'\n\t\t},\n\t\tstatusLivechat: 'available',\n\t\troles: 'livechat-agent',\n\t\tusername: {\n\t\t\t$in: [].concat(userList)\n\t\t}\n\t};\n\n\treturn this.find(query);\n};\n\n/**\n * Get next user agent in order\n * @return {object} User from db\n */\nRocketChat.models.Users.getNextAgent = function() {\n\tconst query = {\n\t\tstatus: {\n\t\t\t$exists: true,\n\t\t\t$ne: 'offline'\n\t\t},\n\t\tstatusLivechat: 'available',\n\t\troles: 'livechat-agent'\n\t};\n\n\tconst collectionObj = this.model.rawCollection();\n\tconst findAndModify = Meteor.wrapAsync(collectionObj.findAndModify, collectionObj);\n\n\tconst sort = {\n\t\tlivechatCount: 1,\n\t\tusername: 1\n\t};\n\n\tconst update = {\n\t\t$inc: {\n\t\t\tlivechatCount: 1\n\t\t}\n\t};\n\n\tconst user = findAndModify(query, sort, update);\n\tif (user && user.value) {\n\t\treturn {\n\t\t\tagentId: user.value._id,\n\t\t\tusername: user.value.username\n\t\t};\n\t} else {\n\t\treturn null;\n\t}\n};\n\n/**\n * Change user's livechat status\n * @param {string} token - Visitor token\n */\nRocketChat.models.Users.setLivechatStatus = function(userId, status) {\n\tconst query = {\n\t\t'_id': userId\n\t};\n\n\tconst update = {\n\t\t$set: {\n\t\t\t'statusLivechat': status\n\t\t}\n\t};\n\n\treturn this.update(query, update);\n};\n\n/**\n * change all livechat agents livechat status to \"not-available\"\n */\nRocketChat.models.Users.closeOffice = function() {\n\tself = this;\n\tself.findAgents().forEach(function(agent) {\n\t\tself.setLivechatStatus(agent._id, 'not-available');\n\t});\n};\n\n/**\n * change all livechat agents livechat status to \"available\"\n */\nRocketChat.models.Users.openOffice = function() {\n\tself = this;\n\tself.findAgents().forEach(function(agent) {\n\t\tself.setLivechatStatus(agent._id, 'available');\n\t});\n};\n\nRocketChat.models.Users.getAgentInfo = function(agentId) {\n\tconst query = {\n\t\t_id: agentId\n\t};\n\n\tconst options = {\n\t\tfields: {\n\t\t\tname: 1,\n\t\t\tusername: 1,\n\t\t\tphone: 1,\n\t\t\tcustomFields: 1\n\t\t}\n\t};\n\n\tif (RocketChat.settings.get('Livechat_show_agent_email')) {\n\t\toptions.fields.emails = 1;\n\t}\n\n\treturn this.findOne(query, options);\n};\n","import _ from 'underscore';\n\n/**\n * Gets visitor by token\n * @param {string} token - Visitor token\n */\nRocketChat.models.Rooms.updateSurveyFeedbackById = function(_id, surveyFeedback) {\n\tconst query = {\n\t\t_id\n\t};\n\n\tconst update = {\n\t\t$set: {\n\t\t\tsurveyFeedback\n\t\t}\n\t};\n\n\treturn this.update(query, update);\n};\n\nRocketChat.models.Rooms.updateLivechatDataByToken = function(token, key, value, overwrite = true) {\n\tconst query = {\n\t\t'v.token': token,\n\t\topen: true\n\t};\n\n\tif (!overwrite) {\n\t\tconst room = this.findOne(query, { fields: { livechatData: 1 } });\n\t\tif (room.livechatData && typeof room.livechatData[key] !== 'undefined') {\n\t\t\treturn true;\n\t\t}\n\t}\n\n\tconst update = {\n\t\t$set: {\n\t\t\t[`livechatData.${ key }`]: value\n\t\t}\n\t};\n\n\treturn this.update(query, update);\n};\n\nRocketChat.models.Rooms.findLivechat = function(filter = {}, offset = 0, limit = 20) {\n\tconst query = _.extend(filter, {\n\t\tt: 'l'\n\t});\n\n\treturn this.find(query, { sort: { ts: - 1 }, offset, limit });\n};\n\nRocketChat.models.Rooms.findLivechatById = function(_id, fields) {\n\tconst options = {};\n\n\tif (fields) {\n\t\toptions.fields = fields;\n\t}\n\n\tconst query = {\n\t\tt: 'l',\n\t\t_id\n\t};\n\n\treturn this.findOne(query, options);\n};\n\nRocketChat.models.Rooms.findLivechatById = function(_id, fields) {\n\tconst options = {};\n\n\tif (fields) {\n\t\toptions.fields = fields;\n\t}\n\n\tconst query = {\n\t\tt: 'l',\n\t\t_id\n\t};\n\n\treturn this.findOne(query, options);\n};\n\n/**\n * Get the next visitor name\n * @return {string} The next visitor name\n */\nRocketChat.models.Rooms.updateLivechatRoomCount = function() {\n\tconst settingsRaw = RocketChat.models.Settings.model.rawCollection();\n\tconst findAndModify = Meteor.wrapAsync(settingsRaw.findAndModify, settingsRaw);\n\n\tconst query = {\n\t\t_id: 'Livechat_Room_Count'\n\t};\n\n\tconst update = {\n\t\t$inc: {\n\t\t\tvalue: 1\n\t\t}\n\t};\n\n\tconst livechatCount = findAndModify(query, null, update);\n\n\treturn livechatCount.value.value;\n};\n\nRocketChat.models.Rooms.findOpenByVisitorToken = function(visitorToken, options) {\n\tconst query = {\n\t\topen: true,\n\t\t'v.token': visitorToken\n\t};\n\n\treturn this.find(query, options);\n};\n\nRocketChat.models.Rooms.findByVisitorToken = function(visitorToken) {\n\tconst query = {\n\t\t'v.token': visitorToken\n\t};\n\n\treturn this.find(query);\n};\n\nRocketChat.models.Rooms.findByVisitorId = function(visitorId) {\n\tconst query = {\n\t\t'v._id': visitorId\n\t};\n\n\treturn this.find(query);\n};\n\nRocketChat.models.Rooms.findOneOpenByVisitorToken = function(token, roomId) {\n\tconst query = {\n\t\t_id: roomId,\n\t\topen: true,\n\t\t'v.token': token\n\t};\n\n\treturn this.findOne(query);\n};\n\nRocketChat.models.Rooms.setResponseByRoomId = function(roomId, response) {\n\treturn this.update({\n\t\t_id: roomId\n\t}, {\n\t\t$set: {\n\t\t\tresponseBy: {\n\t\t\t\t_id: response.user._id,\n\t\t\t\tusername: response.user.username\n\t\t\t},\n\t\t\tresponseDate: response.responseDate,\n\t\t\tresponseTime: response.responseTime\n\t\t},\n\t\t$unset: {\n\t\t\twaitingResponse: 1\n\t\t}\n\t});\n};\n\nRocketChat.models.Rooms.closeByRoomId = function(roomId, closeInfo) {\n\treturn this.update({\n\t\t_id: roomId\n\t}, {\n\t\t$set: {\n\t\t\tcloser: closeInfo.closer,\n\t\t\tclosedBy: closeInfo.closedBy,\n\t\t\tclosedAt: closeInfo.closedAt,\n\t\t\tchatDuration: closeInfo.chatDuration,\n\t\t\t'v.status': 'offline'\n\t\t},\n\t\t$unset: {\n\t\t\topen: 1\n\t\t}\n\t});\n};\n\nRocketChat.models.Rooms.findOpenByAgent = function(userId) {\n\tconst query = {\n\t\topen: true,\n\t\t'servedBy._id': userId\n\t};\n\n\treturn this.find(query);\n};\n\nRocketChat.models.Rooms.changeAgentByRoomId = function(roomId, newAgent) {\n\tconst query = {\n\t\t_id: roomId\n\t};\n\tconst update = {\n\t\t$set: {\n\t\t\tservedBy: {\n\t\t\t\t_id: newAgent.agentId,\n\t\t\t\tusername: newAgent.username\n\t\t\t}\n\t\t}\n\t};\n\n\tthis.update(query, update);\n};\n\nRocketChat.models.Rooms.saveCRMDataByRoomId = function(roomId, crmData) {\n\tconst query = {\n\t\t_id: roomId\n\t};\n\tconst update = {\n\t\t$set: {\n\t\t\tcrmData\n\t\t}\n\t};\n\n\treturn this.update(query, update);\n};\n\nRocketChat.models.Rooms.updateVisitorStatus = function(token, status) {\n\tconst query = {\n\t\t'v.token': token,\n\t\topen: true\n\t};\n\n\tconst update = {\n\t\t$set: {\n\t\t\t'v.status': status\n\t\t}\n\t};\n\n\treturn this.update(query, update);\n};\n","RocketChat.models.Messages.keepHistoryForToken = function(token) {\n\treturn this.update({\n\t\t'navigation.token': token,\n\t\texpireAt: {\n\t\t\t$exists: true\n\t\t}\n\t}, {\n\t\t$unset: {\n\t\t\texpireAt: 1\n\t\t}\n\t}, {\n\t\tmulti: true\n\t});\n};\n\nRocketChat.models.Messages.setRoomIdByToken = function(token, rid) {\n\treturn this.update({\n\t\t'navigation.token': token,\n\t\trid: null\n\t}, {\n\t\t$set: {\n\t\t\trid\n\t\t}\n\t}, {\n\t\tmulti: true\n\t});\n};\n","class LivechatExternalMessage extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_external_message');\n\n\t\tif (Meteor.isClient) {\n\t\t\tthis._initModel('livechat_external_message');\n\t\t}\n\t}\n\n\t// FIND\n\tfindByRoomId(roomId, sort = { ts: -1 }) {\n\t\tconst query = { rid: roomId };\n\n\t\treturn this.find(query, { sort });\n\t}\n}\n\nRocketChat.models.LivechatExternalMessage = new LivechatExternalMessage();\n","import _ from 'underscore';\n\n/**\n * Livechat Custom Fields model\n */\nclass LivechatCustomField extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_custom_field');\n\t}\n\n\t// FIND\n\tfindOneById(_id, options) {\n\t\tconst query = { _id };\n\n\t\treturn this.findOne(query, options);\n\t}\n\n\tcreateOrUpdateCustomField(_id, field, label, scope, visibility, extraData) {\n\t\tconst record = {\n\t\t\tlabel,\n\t\t\tscope,\n\t\t\tvisibility\n\t\t};\n\n\t\t_.extend(record, extraData);\n\n\t\tif (_id) {\n\t\t\tthis.update({ _id }, { $set: record });\n\t\t} else {\n\t\t\trecord._id = field;\n\t\t\t_id = this.insert(record);\n\t\t}\n\n\t\treturn record;\n\t}\n\n\t// REMOVE\n\tremoveById(_id) {\n\t\tconst query = { _id };\n\n\t\treturn this.remove(query);\n\t}\n}\n\nRocketChat.models.LivechatCustomField = new LivechatCustomField();\n","import _ from 'underscore';\n\n/**\n * Livechat Department model\n */\nclass LivechatDepartment extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_department');\n\n\t\tthis.tryEnsureIndex({\n\t\t\tnumAgents: 1,\n\t\t\tenabled: 1\n\t\t});\n\t}\n\n\t// FIND\n\tfindOneById(_id, options) {\n\t\tconst query = { _id };\n\n\t\treturn this.findOne(query, options);\n\t}\n\n\tfindByDepartmentId(_id, options) {\n\t\tconst query = { _id };\n\n\t\treturn this.find(query, options);\n\t}\n\n\tcreateOrUpdateDepartment(_id, { enabled, name, description, showOnRegistration }, agents) {\n\t\tagents = [].concat(agents);\n\n\t\tconst record = {\n\t\t\tenabled,\n\t\t\tname,\n\t\t\tdescription,\n\t\t\tnumAgents: agents.length,\n\t\t\tshowOnRegistration\n\t\t};\n\n\t\tif (_id) {\n\t\t\tthis.update({ _id }, { $set: record });\n\t\t} else {\n\t\t\t_id = this.insert(record);\n\t\t}\n\n\t\tconst savedAgents = _.pluck(RocketChat.models.LivechatDepartmentAgents.findByDepartmentId(_id).fetch(), 'agentId');\n\t\tconst agentsToSave = _.pluck(agents, 'agentId');\n\n\t\t// remove other agents\n\t\t_.difference(savedAgents, agentsToSave).forEach((agentId) => {\n\t\t\tRocketChat.models.LivechatDepartmentAgents.removeByDepartmentIdAndAgentId(_id, agentId);\n\t\t});\n\n\t\tagents.forEach((agent) => {\n\t\t\tRocketChat.models.LivechatDepartmentAgents.saveAgent({\n\t\t\t\tagentId: agent.agentId,\n\t\t\t\tdepartmentId: _id,\n\t\t\t\tusername: agent.username,\n\t\t\t\tcount: agent.count ? parseInt(agent.count) : 0,\n\t\t\t\torder: agent.order ? parseInt(agent.order) : 0\n\t\t\t});\n\t\t});\n\n\t\treturn _.extend(record, { _id });\n\t}\n\n\t// REMOVE\n\tremoveById(_id) {\n\t\tconst query = { _id };\n\n\t\treturn this.remove(query);\n\t}\n\n\tfindEnabledWithAgents() {\n\t\tconst query = {\n\t\t\tnumAgents: { $gt: 0 },\n\t\t\tenabled: true\n\t\t};\n\t\treturn this.find(query);\n\t}\n}\n\nRocketChat.models.LivechatDepartment = new LivechatDepartment();\n","import _ from 'underscore';\n/**\n * Livechat Department model\n */\nclass LivechatDepartmentAgents extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_department_agents');\n\t}\n\n\tfindByDepartmentId(departmentId) {\n\t\treturn this.find({ departmentId });\n\t}\n\n\tsaveAgent(agent) {\n\t\treturn this.upsert({\n\t\t\tagentId: agent.agentId,\n\t\t\tdepartmentId: agent.departmentId\n\t\t}, {\n\t\t\t$set: {\n\t\t\t\tusername: agent.username,\n\t\t\t\tcount: parseInt(agent.count),\n\t\t\t\torder: parseInt(agent.order)\n\t\t\t}\n\t\t});\n\t}\n\n\tremoveByDepartmentIdAndAgentId(departmentId, agentId) {\n\t\tthis.remove({ departmentId, agentId });\n\t}\n\n\tgetNextAgentForDepartment(departmentId) {\n\t\tconst agents = this.findByDepartmentId(departmentId).fetch();\n\n\t\tif (agents.length === 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst onlineUsers = RocketChat.models.Users.findOnlineUserFromList(_.pluck(agents, 'username'));\n\n\t\tconst onlineUsernames = _.pluck(onlineUsers.fetch(), 'username');\n\n\t\tconst query = {\n\t\t\tdepartmentId,\n\t\t\tusername: {\n\t\t\t\t$in: onlineUsernames\n\t\t\t}\n\t\t};\n\n\t\tconst sort = {\n\t\t\tcount: 1,\n\t\t\torder: 1,\n\t\t\tusername: 1\n\t\t};\n\t\tconst update = {\n\t\t\t$inc: {\n\t\t\t\tcount: 1\n\t\t\t}\n\t\t};\n\n\t\tconst collectionObj = this.model.rawCollection();\n\t\tconst findAndModify = Meteor.wrapAsync(collectionObj.findAndModify, collectionObj);\n\n\t\tconst agent = findAndModify(query, sort, update);\n\t\tif (agent && agent.value) {\n\t\t\treturn {\n\t\t\t\tagentId: agent.value.agentId,\n\t\t\t\tusername: agent.value.username\n\t\t\t};\n\t\t} else {\n\t\t\treturn null;\n\t\t}\n\t}\n\n\tgetOnlineForDepartment(departmentId) {\n\t\tconst agents = this.findByDepartmentId(departmentId).fetch();\n\n\t\tif (agents.length === 0) {\n\t\t\treturn [];\n\t\t}\n\n\t\tconst onlineUsers = RocketChat.models.Users.findOnlineUserFromList(_.pluck(agents, 'username'));\n\n\t\tconst onlineUsernames = _.pluck(onlineUsers.fetch(), 'username');\n\n\t\tconst query = {\n\t\t\tdepartmentId,\n\t\t\tusername: {\n\t\t\t\t$in: onlineUsernames\n\t\t\t}\n\t\t};\n\n\t\tconst depAgents = this.find(query);\n\n\t\tif (depAgents) {\n\t\t\treturn depAgents;\n\t\t} else {\n\t\t\treturn [];\n\t\t}\n\t}\n\n\tfindUsersInQueue(usersList) {\n\t\tconst query = {};\n\n\t\tif (!_.isEmpty(usersList)) {\n\t\t\tquery.username = {\n\t\t\t\t$in: usersList\n\t\t\t};\n\t\t}\n\n\t\tconst options = {\n\t\t\tsort: {\n\t\t\t\tdepartmentId: 1,\n\t\t\t\tcount: 1,\n\t\t\t\torder: 1,\n\t\t\t\tusername: 1\n\t\t\t}\n\t\t};\n\n\t\treturn this.find(query, options);\n\t}\n\n\treplaceUsernameOfAgentByUserId(userId, username) {\n\t\tconst query = {'agentId': userId};\n\n\t\tconst update = {\n\t\t\t$set: {\n\t\t\t\tusername\n\t\t\t}\n\t\t};\n\n\t\treturn this.update(query, update, { multi: true });\n\t}\n}\n\nRocketChat.models.LivechatDepartmentAgents = new LivechatDepartmentAgents();\n","/**\n * Livechat Page Visited model\n */\nclass LivechatPageVisited extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_page_visited');\n\n\t\tthis.tryEnsureIndex({ 'token': 1 });\n\t\tthis.tryEnsureIndex({ 'ts': 1 });\n\n\t\t// keep history for 1 month if the visitor does not register\n\t\tthis.tryEnsureIndex({ 'expireAt': 1 }, { sparse: 1, expireAfterSeconds: 0 });\n\t}\n\n\tsaveByToken(token, pageInfo) {\n\t\t// keep history of unregistered visitors for 1 month\n\t\tconst keepHistoryMiliseconds = 2592000000;\n\n\t\treturn this.insert({\n\t\t\ttoken,\n\t\t\tpage: pageInfo,\n\t\t\tts: new Date(),\n\t\t\texpireAt: new Date().getTime() + keepHistoryMiliseconds\n\t\t});\n\t}\n\n\tfindByToken(token) {\n\t\treturn this.find({ token }, { sort : { ts: -1 }, limit: 20 });\n\t}\n\n\tkeepHistoryForToken(token) {\n\t\treturn this.update({\n\t\t\ttoken,\n\t\t\texpireAt: {\n\t\t\t\t$exists: true\n\t\t\t}\n\t\t}, {\n\t\t\t$unset: {\n\t\t\t\texpireAt: 1\n\t\t\t}\n\t\t}, {\n\t\t\tmulti: true\n\t\t});\n\t}\n}\n\nRocketChat.models.LivechatPageVisited = new LivechatPageVisited();\n","/**\n * Livechat Trigger model\n */\nclass LivechatTrigger extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_trigger');\n\t}\n\n\tupdateById(_id, data) {\n\t\treturn this.update({ _id }, { $set: data });\n\t}\n\n\tremoveAll() {\n\t\treturn this.remove({});\n\t}\n\n\tfindById(_id) {\n\t\treturn this.find({ _id });\n\t}\n\n\tremoveById(_id) {\n\t\treturn this.remove({ _id });\n\t}\n\n\tfindEnabled() {\n\t\treturn this.find({ enabled: true });\n\t}\n}\n\nRocketChat.models.LivechatTrigger = new LivechatTrigger();\n","Meteor.startup(function() {\n\tRocketChat.models.Rooms.tryEnsureIndex({ open: 1 }, { sparse: 1 });\n\tRocketChat.models.Users.tryEnsureIndex({ 'visitorEmails.address': 1 });\n});\n","class LivechatInquiry extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_inquiry');\n\n\t\tthis.tryEnsureIndex({ 'rid': 1 }); // room id corresponding to this inquiry\n\t\tthis.tryEnsureIndex({ 'name': 1 }); // name of the inquiry (client name for now)\n\t\tthis.tryEnsureIndex({ 'message': 1 }); // message sent by the client\n\t\tthis.tryEnsureIndex({ 'ts': 1 }); // timestamp\n\t\tthis.tryEnsureIndex({ 'agents': 1}); // Id's of the agents who can see the inquiry (handle departments)\n\t\tthis.tryEnsureIndex({ 'status': 1}); // 'open', 'taken'\n\t}\n\n\tfindOneById(inquiryId) {\n\t\treturn this.findOne({ _id: inquiryId });\n\t}\n\n\t/*\n\t * mark the inquiry as taken\n\t */\n\ttakeInquiry(inquiryId) {\n\t\tthis.update({\n\t\t\t'_id': inquiryId\n\t\t}, {\n\t\t\t$set: { status: 'taken' }\n\t\t});\n\t}\n\n\t/*\n\t * mark the inquiry as closed\n\t */\n\tcloseByRoomId(roomId, closeInfo) {\n\t\treturn this.update({\n\t\t\trid: roomId\n\t\t}, {\n\t\t\t$set: {\n\t\t\t\tstatus: 'closed',\n\t\t\t\tcloser: closeInfo.closer,\n\t\t\t\tclosedBy: closeInfo.closedBy,\n\t\t\t\tclosedAt: closeInfo.closedAt,\n\t\t\t\tchatDuration: closeInfo.chatDuration\n\t\t\t}\n\t\t});\n\t}\n\n\t/*\n\t * mark inquiry as open\n\t */\n\topenInquiry(inquiryId) {\n\t\tthis.update({\n\t\t\t'_id': inquiryId\n\t\t}, {\n\t\t\t$set: { status: 'open' }\n\t\t});\n\t}\n\n\t/*\n\t * return the status of the inquiry (open or taken)\n\t */\n\tgetStatus(inquiryId) {\n\t\treturn this.findOne({'_id': inquiryId}).status;\n\t}\n\n\tupdateVisitorStatus(token, status) {\n\t\tconst query = {\n\t\t\t'v.token': token,\n\t\t\tstatus: 'open'\n\t\t};\n\n\t\tconst update = {\n\t\t\t$set: {\n\t\t\t\t'v.status': status\n\t\t\t}\n\t\t};\n\n\t\treturn this.update(query, update);\n\t}\n}\n\nRocketChat.models.LivechatInquiry = new LivechatInquiry();\n","import moment from 'moment';\n\nclass LivechatOfficeHour extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_office_hour');\n\n\t\tthis.tryEnsureIndex({ 'day': 1 }); // the day of the week monday - sunday\n\t\tthis.tryEnsureIndex({ 'start': 1 }); // the opening hours of the office\n\t\tthis.tryEnsureIndex({ 'finish': 1 }); // the closing hours of the office\n\t\tthis.tryEnsureIndex({ 'open': 1 }); // whether or not the offices are open on this day\n\n\t\t// if there is nothing in the collection, add defaults\n\t\tif (this.find().count() === 0) {\n\t\t\tthis.insert({'day' : 'Monday', 'start' : '08:00', 'finish' : '20:00', 'code' : 1, 'open' : true });\n\t\t\tthis.insert({'day' : 'Tuesday', 'start' : '08:00', 'finish' : '20:00', 'code' : 2, 'open' : true });\n\t\t\tthis.insert({'day' : 'Wednesday', 'start' : '08:00', 'finish' : '20:00', 'code' : 3, 'open' : true });\n\t\t\tthis.insert({'day' : 'Thursday', 'start' : '08:00', 'finish' : '20:00', 'code' : 4, 'open' : true });\n\t\t\tthis.insert({'day' : 'Friday', 'start' : '08:00', 'finish' : '20:00', 'code' : 5, 'open' : true });\n\t\t\tthis.insert({'day' : 'Saturday', 'start' : '08:00', 'finish' : '20:00', 'code' : 6, 'open' : false });\n\t\t\tthis.insert({'day' : 'Sunday', 'start' : '08:00', 'finish' : '20:00', 'code' : 0, 'open' : false });\n\t\t}\n\t}\n\n\t/*\n\t * update the given days start and finish times and whether the office is open on that day\n\t */\n\tupdateHours(day, newStart, newFinish, newOpen) {\n\t\tthis.update({\n\t\t\tday\n\t\t}, {\n\t\t\t$set: {\n\t\t\t\tstart: newStart,\n\t\t\t\tfinish: newFinish,\n\t\t\t\topen: newOpen\n\t\t\t}\n\t\t});\n\t}\n\n\t/*\n\t * Check if the current server time (utc) is within the office hours of that day\n\t * returns true or false\n\t */\n\tisNowWithinHours() {\n\t\t// get current time on server in utc\n\t\t// var ct = moment().utc();\n\t\tconst currentTime = moment.utc(moment().utc().format('dddd:HH:mm'), 'dddd:HH:mm');\n\n\t\t// get todays office hours from db\n\t\tconst todaysOfficeHours = this.findOne({day: currentTime.format('dddd')});\n\t\tif (!todaysOfficeHours) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// check if offices are open today\n\t\tif (todaysOfficeHours.open === false) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst start = moment.utc(`${ todaysOfficeHours.day }:${ todaysOfficeHours.start }`, 'dddd:HH:mm');\n\t\tconst finish = moment.utc(`${ todaysOfficeHours.day }:${ todaysOfficeHours.finish }`, 'dddd:HH:mm');\n\n\t\t// console.log(finish.isBefore(start));\n\t\tif (finish.isBefore(start)) {\n\t\t\t// finish.day(finish.day()+1);\n\t\t\tfinish.add(1, 'days');\n\t\t}\n\n\t\tconst result = currentTime.isBetween(start, finish);\n\n\t\t// inBetween  check\n\t\treturn result;\n\t}\n\n\tisOpeningTime() {\n\t\t// get current time on server in utc\n\t\tconst currentTime = moment.utc(moment().utc().format('dddd:HH:mm'), 'dddd:HH:mm');\n\n\t\t// get todays office hours from db\n\t\tconst todaysOfficeHours = this.findOne({day: currentTime.format('dddd')});\n\t\tif (!todaysOfficeHours) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// check if offices are open today\n\t\tif (todaysOfficeHours.open === false) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst start = moment.utc(`${ todaysOfficeHours.day }:${ todaysOfficeHours.start }`, 'dddd:HH:mm');\n\n\t\treturn start.isSame(currentTime, 'minute');\n\t}\n\n\tisClosingTime() {\n\t\t// get current time on server in utc\n\t\tconst currentTime = moment.utc(moment().utc().format('dddd:HH:mm'), 'dddd:HH:mm');\n\n\t\t// get todays office hours from db\n\t\tconst todaysOfficeHours = this.findOne({day: currentTime.format('dddd')});\n\t\tif (!todaysOfficeHours) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst finish = moment.utc(`${ todaysOfficeHours.day }:${ todaysOfficeHours.finish }`, 'dddd:HH:mm');\n\n\t\treturn finish.isSame(currentTime, 'minute');\n\t}\n}\n\nRocketChat.models.LivechatOfficeHour = new LivechatOfficeHour();\n","import _ from 'underscore';\nimport s from 'underscore.string';\n\nclass LivechatVisitors extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_visitor');\n\t}\n\n\t/**\n\t * Gets visitor by token\n\t * @param {string} token - Visitor token\n\t */\n\tgetVisitorByToken(token, options) {\n\t\tconst query = {\n\t\t\ttoken\n\t\t};\n\n\t\treturn this.findOne(query, options);\n\t}\n\n\t/**\n\t * Find visitors by _id\n\t * @param {string} token - Visitor token\n\t */\n\tfindById(_id, options) {\n\t\tconst query = {\n\t\t\t_id\n\t\t};\n\n\t\treturn this.find(query, options);\n\t}\n\n\t/**\n\t * Gets visitor by token\n\t * @param {string} token - Visitor token\n\t */\n\tfindVisitorByToken(token) {\n\t\tconst query = {\n\t\t\ttoken\n\t\t};\n\n\t\treturn this.find(query);\n\t}\n\n\tupdateLivechatDataByToken(token, key, value, overwrite = true) {\n\t\tconst query = {\n\t\t\ttoken\n\t\t};\n\n\t\tif (!overwrite) {\n\t\t\tconst user = this.findOne(query, { fields: { livechatData: 1 } });\n\t\t\tif (user.livechatData && typeof user.livechatData[key] !== 'undefined') {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\n\t\tconst update = {\n\t\t\t$set: {\n\t\t\t\t[`livechatData.${ key }`]: value\n\t\t\t}\n\t\t};\n\n\t\treturn this.update(query, update);\n\t}\n\n\t/**\n\t * Find a visitor by their phone number\n\t * @return {object} User from db\n\t */\n\tfindOneVisitorByPhone(phone) {\n\t\tconst query = {\n\t\t\t'phone.phoneNumber': phone\n\t\t};\n\n\t\treturn this.findOne(query);\n\t}\n\n\t/**\n\t * Get the next visitor name\n\t * @return {string} The next visitor name\n\t */\n\tgetNextVisitorUsername() {\n\t\tconst settingsRaw = RocketChat.models.Settings.model.rawCollection();\n\t\tconst findAndModify = Meteor.wrapAsync(settingsRaw.findAndModify, settingsRaw);\n\n\t\tconst query = {\n\t\t\t_id: 'Livechat_guest_count'\n\t\t};\n\n\t\tconst update = {\n\t\t\t$inc: {\n\t\t\t\tvalue: 1\n\t\t\t}\n\t\t};\n\n\t\tconst livechatCount = findAndModify(query, null, update);\n\n\t\treturn `guest-${ livechatCount.value.value + 1 }`;\n\t}\n\n\tupdateById(_id, update) {\n\t\treturn this.update({ _id }, update);\n\t}\n\n\tsaveGuestById(_id, data) {\n\t\tconst setData = {};\n\t\tconst unsetData = {};\n\n\t\tif (data.name) {\n\t\t\tif (!_.isEmpty(s.trim(data.name))) {\n\t\t\t\tsetData.name = s.trim(data.name);\n\t\t\t} else {\n\t\t\t\tunsetData.name = 1;\n\t\t\t}\n\t\t}\n\n\t\tif (data.email) {\n\t\t\tif (!_.isEmpty(s.trim(data.email))) {\n\t\t\t\tsetData.visitorEmails = [\n\t\t\t\t\t{ address: s.trim(data.email) }\n\t\t\t\t];\n\t\t\t} else {\n\t\t\t\tunsetData.visitorEmails = 1;\n\t\t\t}\n\t\t}\n\n\t\tif (data.phone) {\n\t\t\tif (!_.isEmpty(s.trim(data.phone))) {\n\t\t\t\tsetData.phone = [\n\t\t\t\t\t{ phoneNumber: s.trim(data.phone) }\n\t\t\t\t];\n\t\t\t} else {\n\t\t\t\tunsetData.phone = 1;\n\t\t\t}\n\t\t}\n\n\t\tconst update = {};\n\n\t\tif (!_.isEmpty(setData)) {\n\t\t\tupdate.$set = setData;\n\t\t}\n\n\t\tif (!_.isEmpty(unsetData)) {\n\t\t\tupdate.$unset = unsetData;\n\t\t}\n\n\t\tif (_.isEmpty(update)) {\n\t\t\treturn true;\n\t\t}\n\n\t\treturn this.update({ _id }, update);\n\t}\n\n\tfindOneGuestByEmailAddress(emailAddress) {\n\t\tconst query = {\n\t\t\t'visitorEmails.address': new RegExp(`^${ s.escapeRegExp(emailAddress) }$`, 'i')\n\t\t};\n\n\t\treturn this.findOne(query);\n\t}\n\n\tsaveGuestEmailPhoneById(_id, emails, phones) {\n\t\tconst update = {\n\t\t\t$addToSet: {}\n\t\t};\n\n\t\tconst saveEmail = [].concat(emails)\n\t\t\t.filter(email => email && email.trim())\n\t\t\t.map(email => {\n\t\t\t\treturn { address: email };\n\t\t\t});\n\n\t\tif (saveEmail.length > 0) {\n\t\t\tupdate.$addToSet.visitorEmails = { $each: saveEmail };\n\t\t}\n\n\t\tconst savePhone = [].concat(phones)\n\t\t\t.filter(phone => phone && phone.trim().replace(/[^\\d]/g, ''))\n\t\t\t.map(phone => {\n\t\t\t\treturn { phoneNumber: phone };\n\t\t\t});\n\n\t\tif (savePhone.length > 0) {\n\t\t\tupdate.$addToSet.phone = { $each: savePhone };\n\t\t}\n\n\t\tif (!update.$addToSet.visitorEmails && !update.$addToSet.phone) {\n\t\t\treturn;\n\t\t}\n\n\t\treturn this.update({ _id }, update);\n\t}\n}\n\nexport default new LivechatVisitors();\n","/* globals HTTP */\nimport _ from 'underscore';\nimport s from 'underscore.string';\nimport UAParser from 'ua-parser-js';\nimport LivechatVisitors from '../models/LivechatVisitors';\n\nRocketChat.Livechat = {\n\thistoryMonitorType: 'url',\n\n\tlogger: new Logger('Livechat', {\n\t\tsections: {\n\t\t\twebhook: 'Webhook'\n\t\t}\n\t}),\n\n\tgetNextAgent(department) {\n\t\tif (RocketChat.settings.get('Livechat_Routing_Method') === 'External') {\n\t\t\tfor (let i = 0; i < 10; i++) {\n\t\t\t\ttry {\n\t\t\t\t\tconst queryString = department ? `?departmentId=${ department }` : '';\n\t\t\t\t\tconst result = HTTP.call('GET', `${ RocketChat.settings.get('Livechat_External_Queue_URL') }${ queryString }`, {\n\t\t\t\t\t\theaders: {\n\t\t\t\t\t\t\t'User-Agent': 'RocketChat Server',\n\t\t\t\t\t\t\t'Accept': 'application/json',\n\t\t\t\t\t\t\t'X-RocketChat-Secret-Token': RocketChat.settings.get('Livechat_External_Queue_Token')\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\n\t\t\t\t\tif (result && result.data && result.data.username) {\n\t\t\t\t\t\tconst agent = RocketChat.models.Users.findOneOnlineAgentByUsername(result.data.username);\n\n\t\t\t\t\t\tif (agent) {\n\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\tagentId: agent._id,\n\t\t\t\t\t\t\t\tusername: agent.username\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} catch (e) {\n\t\t\t\t\tconsole.error('Error requesting agent from external queue.', e);\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t\tthrow new Meteor.Error('no-agent-online', 'Sorry, no online agents');\n\t\t} else if (department) {\n\t\t\treturn RocketChat.models.LivechatDepartmentAgents.getNextAgentForDepartment(department);\n\t\t}\n\t\treturn RocketChat.models.Users.getNextAgent();\n\t},\n\tgetAgents(department) {\n\t\tif (department) {\n\t\t\treturn RocketChat.models.LivechatDepartmentAgents.findByDepartmentId(department);\n\t\t} else {\n\t\t\treturn RocketChat.models.Users.findAgents();\n\t\t}\n\t},\n\tgetOnlineAgents(department) {\n\t\tif (department) {\n\t\t\treturn RocketChat.models.LivechatDepartmentAgents.getOnlineForDepartment(department);\n\t\t} else {\n\t\t\treturn RocketChat.models.Users.findOnlineAgents();\n\t\t}\n\t},\n\tgetRequiredDepartment(onlineRequired = true) {\n\t\tconst departments = RocketChat.models.LivechatDepartment.findEnabledWithAgents();\n\n\t\treturn departments.fetch().find((dept) => {\n\t\t\tif (!dept.showOnRegistration) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\tif (!onlineRequired) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\tconst onlineAgents = RocketChat.models.LivechatDepartmentAgents.getOnlineForDepartment(dept._id);\n\t\t\treturn onlineAgents.count() > 0;\n\t\t});\n\t},\n\tgetRoom(guest, message, roomInfo, agent) {\n\t\tlet room = RocketChat.models.Rooms.findOneById(message.rid);\n\t\tlet newRoom = false;\n\n\t\tif (room && !room.open) {\n\t\t\tmessage.rid = Random.id();\n\t\t\troom = null;\n\t\t}\n\n\t\tif (room == null) {\n\t\t\t// if no department selected verify if there is at least one active and pick the first\n\t\t\tif (!agent && !guest.department) {\n\t\t\t\tconst department = this.getRequiredDepartment();\n\n\t\t\t\tif (department) {\n\t\t\t\t\tguest.department = department._id;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// delegate room creation to QueueMethods\n\t\t\tconst routingMethod = RocketChat.settings.get('Livechat_Routing_Method');\n\t\t\troom = RocketChat.QueueMethods[routingMethod](guest, message, roomInfo, agent);\n\n\t\t\tnewRoom = true;\n\t\t}\n\n\t\tif (!room || room.v.token !== guest.token) {\n\t\t\tthrow new Meteor.Error('cannot-access-room');\n\t\t}\n\n\t\tif (newRoom) {\n\t\t\tRocketChat.models.Messages.setRoomIdByToken(guest.token, room._id);\n\t\t}\n\n\t\treturn { room, newRoom };\n\t},\n\tsendMessage({ guest, message, roomInfo, agent }) {\n\t\tconst { room, newRoom } = this.getRoom(guest, message, roomInfo, agent);\n\t\tif (guest.name) {\n\t\t\tmessage.alias = guest.name;\n\t\t}\n\n\t\t// return messages;\n\t\treturn _.extend(RocketChat.sendMessage(guest, message, room), { newRoom, showConnecting: this.showConnecting() });\n\t},\n\tregisterGuest({ token, name, email, department, phone, username } = {}) {\n\t\tcheck(token, String);\n\n\t\tlet userId;\n\t\tconst updateUser = {\n\t\t\t$set: {\n\t\t\t\ttoken\n\t\t\t}\n\t\t};\n\n\t\tconst user = LivechatVisitors.getVisitorByToken(token, { fields: { _id: 1 } });\n\n\t\tif (user) {\n\t\t\tuserId = user._id;\n\t\t} else {\n\t\t\tif (!username) {\n\t\t\t\tusername = LivechatVisitors.getNextVisitorUsername();\n\t\t\t}\n\n\t\t\tlet existingUser = null;\n\n\t\t\tif (s.trim(email) !== '' && (existingUser = LivechatVisitors.findOneGuestByEmailAddress(email))) {\n\t\t\t\tuserId = existingUser._id;\n\t\t\t} else {\n\t\t\t\tconst userData = {\n\t\t\t\t\tusername,\n\t\t\t\t\tdepartment\n\t\t\t\t};\n\n\t\t\t\tif (this.connection) {\n\t\t\t\t\tuserData.userAgent = this.connection.httpHeaders['user-agent'];\n\t\t\t\t\tuserData.ip = this.connection.httpHeaders['x-real-ip'] || this.connection.httpHeaders['x-forwarded-for'] || this.connection.clientAddress;\n\t\t\t\t\tuserData.host = this.connection.httpHeaders.host;\n\t\t\t\t}\n\n\t\t\t\tuserId = LivechatVisitors.insert(userData);\n\t\t\t}\n\t\t}\n\n\t\tif (phone) {\n\t\t\tupdateUser.$set.phone = [\n\t\t\t\t{ phoneNumber: phone.number }\n\t\t\t];\n\t\t}\n\n\t\tif (email && email.trim() !== '') {\n\t\t\tupdateUser.$set.visitorEmails = [\n\t\t\t\t{ address: email }\n\t\t\t];\n\t\t}\n\n\t\tif (name) {\n\t\t\tupdateUser.$set.name = name;\n\t\t}\n\n\t\tLivechatVisitors.updateById(userId, updateUser);\n\n\t\treturn userId;\n\t},\n\tsetDepartmentForGuest({ token, department } = {}) {\n\t\tcheck(token, String);\n\n\t\tconst updateUser = {\n\t\t\t$set: {\n\t\t\t\tdepartment\n\t\t\t}\n\t\t};\n\n\t\tconst user = LivechatVisitors.getVisitorByToken(token, { fields: { _id: 1 } });\n\t\tif (user) {\n\t\t\treturn Meteor.users.update(user._id, updateUser);\n\t\t}\n\t\treturn false;\n\t},\n\tsaveGuest({ _id, name, email, phone }) {\n\t\tconst updateData = {};\n\n\t\tif (name) {\n\t\t\tupdateData.name = name;\n\t\t}\n\t\tif (email) {\n\t\t\tupdateData.email = email;\n\t\t}\n\t\tif (phone) {\n\t\t\tupdateData.phone = phone;\n\t\t}\n\t\tconst ret = LivechatVisitors.saveGuestById(_id, updateData);\n\n\t\tMeteor.defer(() => {\n\t\t\tRocketChat.callbacks.run('livechat.saveGuest', updateData);\n\t\t});\n\n\t\treturn ret;\n\t},\n\n\tcloseRoom({ user, visitor, room, comment }) {\n\t\tconst now = new Date();\n\n\t\tconst closeData = {\n\t\t\tclosedAt: now,\n\t\t\tchatDuration: (now.getTime() - room.ts) / 1000\n\t\t};\n\n\t\tif (user) {\n\t\t\tcloseData.closer = 'user';\n\t\t\tcloseData.closedBy = {\n\t\t\t\t_id: user._id,\n\t\t\t\tusername: user.username\n\t\t\t};\n\t\t} else if (visitor) {\n\t\t\tcloseData.closer = 'visitor';\n\t\t\tcloseData.closedBy = {\n\t\t\t\t_id: visitor._id,\n\t\t\t\tusername: visitor.username\n\t\t\t};\n\t\t}\n\n\t\tRocketChat.models.Rooms.closeByRoomId(room._id, closeData);\n\t\tRocketChat.models.LivechatInquiry.closeByRoomId(room._id, closeData);\n\n\t\tconst message = {\n\t\t\tt: 'livechat-close',\n\t\t\tmsg: comment,\n\t\t\tgroupable: false\n\t\t};\n\n\t\tRocketChat.sendMessage(user, message, room);\n\n\t\tif (room.servedBy) {\n\t\t\tRocketChat.models.Subscriptions.hideByRoomIdAndUserId(room._id, room.servedBy._id);\n\t\t}\n\t\tRocketChat.models.Messages.createCommandWithRoomIdAndUser('promptTranscript', room._id, closeData.closedBy);\n\n\t\tMeteor.defer(() => {\n\t\t\tRocketChat.callbacks.run('livechat.closeRoom', room);\n\t\t});\n\n\t\treturn true;\n\t},\n\n\tgetInitSettings() {\n\t\tconst settings = {};\n\n\t\tRocketChat.models.Settings.findNotHiddenPublic([\n\t\t\t'Livechat_title',\n\t\t\t'Livechat_title_color',\n\t\t\t'Livechat_enabled',\n\t\t\t'Livechat_registration_form',\n\t\t\t'Livechat_allow_switching_departments',\n\t\t\t'Livechat_offline_title',\n\t\t\t'Livechat_offline_title_color',\n\t\t\t'Livechat_offline_message',\n\t\t\t'Livechat_offline_success_message',\n\t\t\t'Livechat_offline_form_unavailable',\n\t\t\t'Livechat_display_offline_form',\n\t\t\t'Livechat_videocall_enabled',\n\t\t\t'Jitsi_Enabled',\n\t\t\t'Language',\n\t\t\t'Livechat_enable_transcript',\n\t\t\t'Livechat_transcript_message',\n\t\t\t'Livechat_conversation_finished_message',\n\t\t\t'Livechat_name_field_registration_form',\n\t\t\t'Livechat_email_field_registration_form'\n\n\t\t]).forEach((setting) => {\n\t\t\tsettings[setting._id] = setting.value;\n\t\t});\n\n\t\treturn settings;\n\t},\n\n\tsaveRoomInfo(roomData, guestData) {\n\t\tif ((roomData.topic != null || roomData.tags != null) && !RocketChat.models.Rooms.setTopicAndTagsById(roomData._id, roomData.topic, roomData.tags)) {\n\t\t\treturn false;\n\t\t}\n\n\t\tMeteor.defer(() => {\n\t\t\tRocketChat.callbacks.run('livechat.saveRoom', roomData);\n\t\t});\n\n\t\tif (!_.isEmpty(guestData.name)) {\n\t\t\treturn RocketChat.models.Rooms.setFnameById(roomData._id, guestData.name) && RocketChat.models.Subscriptions.updateDisplayNameByRoomId(roomData._id, guestData.name);\n\t\t}\n\t},\n\n\tcloseOpenChats(userId, comment) {\n\t\tconst user = RocketChat.models.Users.findOneById(userId);\n\t\tRocketChat.models.Rooms.findOpenByAgent(userId).forEach((room) => {\n\t\t\tthis.closeRoom({ user, room, comment});\n\t\t});\n\t},\n\n\tforwardOpenChats(userId) {\n\t\tRocketChat.models.Rooms.findOpenByAgent(userId).forEach((room) => {\n\t\t\tconst guest = RocketChat.models.Users.findOneById(room.v._id);\n\t\t\tthis.transfer(room, guest, { departmentId: guest.department });\n\t\t});\n\t},\n\n\tsavePageHistory(token, roomId, pageInfo) {\n\t\tif (pageInfo.change === RocketChat.Livechat.historyMonitorType) {\n\n\t\t\tconst user = RocketChat.models.Users.findOneById('rocket.cat');\n\n\t\t\tconst pageTitle = pageInfo.title;\n\t\t\tconst pageUrl = pageInfo.location.href;\n\t\t\tconst extraData = {\n\t\t\t\tnavigation: {\n\t\t\t\t\tpage: pageInfo,\n\t\t\t\t\ttoken\n\t\t\t\t}\n\t\t\t};\n\n\t\t\tif (!roomId) {\n\t\t\t\t// keep history of unregistered visitors for 1 month\n\t\t\t\tconst keepHistoryMiliseconds = 2592000000;\n\t\t\t\textraData.expireAt = new Date().getTime() + keepHistoryMiliseconds;\n\t\t\t}\n\n\t\t\tif (!RocketChat.settings.get('Livechat_Visitor_navigation_as_a_message')) {\n\t\t\t\textraData._hidden = true;\n\t\t\t}\n\n\t\t\treturn RocketChat.models.Messages.createNavigationHistoryWithRoomIdMessageAndUser(roomId, `${ pageTitle } - ${ pageUrl }`, user, extraData);\n\t\t}\n\n\t\treturn;\n\t},\n\n\ttransfer(room, guest, transferData) {\n\t\tlet agent;\n\n\t\tif (transferData.userId) {\n\t\t\tconst user = RocketChat.models.Users.findOneById(transferData.userId);\n\t\t\tagent = {\n\t\t\t\tagentId: user._id,\n\t\t\t\tusername: user.username\n\t\t\t};\n\t\t} else {\n\t\t\tagent = RocketChat.Livechat.getNextAgent(transferData.departmentId);\n\t\t}\n\n\t\tconst servedBy = room.servedBy;\n\n\t\tif (agent && agent.agentId !== servedBy._id) {\n\t\t\troom.usernames = _.without(room.usernames, servedBy.username).concat(agent.username);\n\n\t\t\tRocketChat.models.Rooms.changeAgentByRoomId(room._id, agent);\n\n\t\t\tconst subscriptionData = {\n\t\t\t\trid: room._id,\n\t\t\t\tname: guest.name || guest.username,\n\t\t\t\talert: true,\n\t\t\t\topen: true,\n\t\t\t\tunread: 1,\n\t\t\t\tuserMentions: 1,\n\t\t\t\tgroupMentions: 0,\n\t\t\t\tu: {\n\t\t\t\t\t_id: agent.agentId,\n\t\t\t\t\tusername: agent.username\n\t\t\t\t},\n\t\t\t\tt: 'l',\n\t\t\t\tdesktopNotifications: 'all',\n\t\t\t\tmobilePushNotifications: 'all',\n\t\t\t\temailNotifications: 'all'\n\t\t\t};\n\t\t\tRocketChat.models.Subscriptions.removeByRoomIdAndUserId(room._id, servedBy._id);\n\n\t\t\tRocketChat.models.Subscriptions.insert(subscriptionData);\n\n\t\t\tRocketChat.models.Messages.createUserLeaveWithRoomIdAndUser(room._id, { _id: servedBy._id, username: servedBy.username });\n\t\t\tRocketChat.models.Messages.createUserJoinWithRoomIdAndUser(room._id, { _id: agent.agentId, username: agent.username });\n\n\t\t\tRocketChat.Livechat.stream.emit(room._id, {\n\t\t\t\ttype: 'agentData',\n\t\t\t\tdata: RocketChat.models.Users.getAgentInfo(agent.agentId)\n\t\t\t});\n\n\t\t\treturn true;\n\t\t}\n\n\t\treturn false;\n\t},\n\n\tsendRequest(postData, callback, trying = 1) {\n\t\ttry {\n\t\t\tconst options = {\n\t\t\t\theaders: {\n\t\t\t\t\t'X-RocketChat-Livechat-Token': RocketChat.settings.get('Livechat_secret_token')\n\t\t\t\t},\n\t\t\t\tdata: postData\n\t\t\t};\n\t\t\treturn HTTP.post(RocketChat.settings.get('Livechat_webhookUrl'), options);\n\t\t} catch (e) {\n\t\t\tRocketChat.Livechat.logger.webhook.error(`Response error on ${ trying } try ->`, e);\n\t\t\t// try 10 times after 10 seconds each\n\t\t\tif (trying < 10) {\n\t\t\t\tRocketChat.Livechat.logger.webhook.warn('Will try again in 10 seconds ...');\n\t\t\t\ttrying++;\n\t\t\t\tsetTimeout(Meteor.bindEnvironment(() => {\n\t\t\t\t\tRocketChat.Livechat.sendRequest(postData, callback, trying);\n\t\t\t\t}), 10000);\n\t\t\t}\n\t\t}\n\t},\n\n\tgetLivechatRoomGuestInfo(room) {\n\t\tconst visitor = LivechatVisitors.findOneById(room.v._id);\n\t\tconst agent = RocketChat.models.Users.findOneById(room.servedBy && room.servedBy._id);\n\n\t\tconst ua = new UAParser();\n\t\tua.setUA(visitor.userAgent);\n\n\t\tconst postData = {\n\t\t\t_id: room._id,\n\t\t\tlabel: room.fname || room.label, // using same field for compatibility\n\t\t\ttopic: room.topic,\n\t\t\tcreatedAt: room.ts,\n\t\t\tlastMessageAt: room.lm,\n\t\t\ttags: room.tags,\n\t\t\tcustomFields: room.livechatData,\n\t\t\tvisitor: {\n\t\t\t\t_id: visitor._id,\n\t\t\t\ttoken: visitor.token,\n\t\t\t\tname: visitor.name,\n\t\t\t\tusername: visitor.username,\n\t\t\t\temail: null,\n\t\t\t\tphone: null,\n\t\t\t\tdepartment: visitor.department,\n\t\t\t\tip: visitor.ip,\n\t\t\t\tos: ua.getOS().name && (`${ ua.getOS().name } ${ ua.getOS().version }`),\n\t\t\t\tbrowser: ua.getBrowser().name && (`${ ua.getBrowser().name } ${ ua.getBrowser().version }`),\n\t\t\t\tcustomFields: visitor.livechatData\n\t\t\t}\n\t\t};\n\n\t\tif (agent) {\n\t\t\tpostData.agent = {\n\t\t\t\t_id: agent._id,\n\t\t\t\tusername: agent.username,\n\t\t\t\tname: agent.name,\n\t\t\t\temail: null\n\t\t\t};\n\n\t\t\tif (agent.emails && agent.emails.length > 0) {\n\t\t\t\tpostData.agent.email = agent.emails[0].address;\n\t\t\t}\n\t\t}\n\n\t\tif (room.crmData) {\n\t\t\tpostData.crmData = room.crmData;\n\t\t}\n\n\t\tif (visitor.visitorEmails && visitor.visitorEmails.length > 0) {\n\t\t\tpostData.visitor.email = visitor.visitorEmails;\n\t\t}\n\t\tif (visitor.phone && visitor.phone.length > 0) {\n\t\t\tpostData.visitor.phone = visitor.phone;\n\t\t}\n\n\t\treturn postData;\n\t},\n\n\taddAgent(username) {\n\t\tcheck(username, String);\n\n\t\tconst user = RocketChat.models.Users.findOneByUsername(username, { fields: { _id: 1, username: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'livechat:addAgent' });\n\t\t}\n\n\t\tif (RocketChat.authz.addUserRoles(user._id, 'livechat-agent')) {\n\t\t\tRocketChat.models.Users.setOperator(user._id, true);\n\t\t\tRocketChat.models.Users.setLivechatStatus(user._id, 'available');\n\t\t\treturn user;\n\t\t}\n\n\t\treturn false;\n\t},\n\n\taddManager(username) {\n\t\tcheck(username, String);\n\n\t\tconst user = RocketChat.models.Users.findOneByUsername(username, { fields: { _id: 1, username: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'livechat:addManager' });\n\t\t}\n\n\t\tif (RocketChat.authz.addUserRoles(user._id, 'livechat-manager')) {\n\t\t\treturn user;\n\t\t}\n\n\t\treturn false;\n\t},\n\n\tremoveAgent(username) {\n\t\tcheck(username, String);\n\n\t\tconst user = RocketChat.models.Users.findOneByUsername(username, { fields: { _id: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'livechat:removeAgent' });\n\t\t}\n\n\t\tif (RocketChat.authz.removeUserFromRoles(user._id, 'livechat-agent')) {\n\t\t\tRocketChat.models.Users.setOperator(user._id, false);\n\t\t\tRocketChat.models.Users.setLivechatStatus(user._id, 'not-available');\n\t\t\treturn true;\n\t\t}\n\n\t\treturn false;\n\t},\n\n\tremoveManager(username) {\n\t\tcheck(username, String);\n\n\t\tconst user = RocketChat.models.Users.findOneByUsername(username, { fields: { _id: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'livechat:removeManager' });\n\t\t}\n\n\t\treturn RocketChat.authz.removeUserFromRoles(user._id, 'livechat-manager');\n\t},\n\n\tsaveDepartment(_id, departmentData, departmentAgents) {\n\t\tcheck(_id, Match.Maybe(String));\n\n\t\tcheck(departmentData, {\n\t\t\tenabled: Boolean,\n\t\t\tname: String,\n\t\t\tdescription: Match.Optional(String),\n\t\t\tshowOnRegistration: Boolean\n\t\t});\n\n\t\tcheck(departmentAgents, [\n\t\t\tMatch.ObjectIncluding({\n\t\t\t\tagentId: String,\n\t\t\t\tusername: String\n\t\t\t})\n\t\t]);\n\n\t\tif (_id) {\n\t\t\tconst department = RocketChat.models.LivechatDepartment.findOneById(_id);\n\t\t\tif (!department) {\n\t\t\t\tthrow new Meteor.Error('error-department-not-found', 'Department not found', { method: 'livechat:saveDepartment' });\n\t\t\t}\n\t\t}\n\n\t\treturn RocketChat.models.LivechatDepartment.createOrUpdateDepartment(_id, departmentData, departmentAgents);\n\t},\n\n\tremoveDepartment(_id) {\n\t\tcheck(_id, String);\n\n\t\tconst department = RocketChat.models.LivechatDepartment.findOneById(_id, { fields: { _id: 1 } });\n\n\t\tif (!department) {\n\t\t\tthrow new Meteor.Error('department-not-found', 'Department not found', { method: 'livechat:removeDepartment' });\n\t\t}\n\n\t\treturn RocketChat.models.LivechatDepartment.removeById(_id);\n\t},\n\n\tshowConnecting() {\n\t\tif (RocketChat.settings.get('Livechat_Routing_Method') === 'Guest_Pool') {\n\t\t\treturn RocketChat.settings.get('Livechat_open_inquiery_show_connecting');\n\t\t} else {\n\t\t\treturn false;\n\t\t}\n\t}\n};\n\nRocketChat.Livechat.stream = new Meteor.Streamer('livechat-room');\n\nRocketChat.Livechat.stream.allowRead((roomId, extraData) => {\n\tconst room = RocketChat.models.Rooms.findOneById(roomId);\n\tif (!room) {\n\t\tconsole.warn(`Invalid eventName: \"${ roomId }\"`);\n\t\treturn false;\n\t}\n\tif (room.t === 'l' && extraData && extraData.token && room.v.token === extraData.token) {\n\t\treturn true;\n\t}\n\treturn false;\n});\n\nRocketChat.settings.get('Livechat_history_monitor_type', (key, value) => {\n\tRocketChat.Livechat.historyMonitorType = value;\n});\n","import _ from 'underscore';\n\nRocketChat.QueueMethods = {\n\t/* Least Amount Queuing method:\n\t *\n\t * default method where the agent with the least number\n\t * of open chats is paired with the incoming livechat\n\t */\n\t'Least_Amount'(guest, message, roomInfo, agent) {\n\t\tif (!agent) {\n\t\t\tagent = RocketChat.Livechat.getNextAgent(guest.department);\n\t\t\tif (!agent) {\n\t\t\t\tthrow new Meteor.Error('no-agent-online', 'Sorry, no online agents');\n\t\t\t}\n\t\t}\n\n\t\tRocketChat.models.Rooms.updateLivechatRoomCount();\n\n\t\tconst room = _.extend({\n\t\t\t_id: message.rid,\n\t\t\tmsgs: 1,\n\t\t\tlm: new Date(),\n\t\t\tfname: (roomInfo && roomInfo.fname) || guest.name || guest.username,\n\t\t\t// usernames: [agent.username, guest.username],\n\t\t\tt: 'l',\n\t\t\tts: new Date(),\n\t\t\tv: {\n\t\t\t\t_id: guest._id,\n\t\t\t\tusername: guest.username,\n\t\t\t\ttoken: message.token,\n\t\t\t\tstatus: guest.status || 'online'\n\t\t\t},\n\t\t\tservedBy: {\n\t\t\t\t_id: agent.agentId,\n\t\t\t\tusername: agent.username\n\t\t\t},\n\t\t\tcl: false,\n\t\t\topen: true,\n\t\t\twaitingResponse: true\n\t\t}, roomInfo);\n\t\tconst subscriptionData = {\n\t\t\trid: message.rid,\n\t\t\tfname: guest.name || guest.username,\n\t\t\talert: true,\n\t\t\topen: true,\n\t\t\tunread: 1,\n\t\t\tuserMentions: 1,\n\t\t\tgroupMentions: 0,\n\t\t\tu: {\n\t\t\t\t_id: agent.agentId,\n\t\t\t\tusername: agent.username\n\t\t\t},\n\t\t\tt: 'l',\n\t\t\tdesktopNotifications: 'all',\n\t\t\tmobilePushNotifications: 'all',\n\t\t\temailNotifications: 'all'\n\t\t};\n\n\t\tRocketChat.models.Rooms.insert(room);\n\t\tRocketChat.models.Subscriptions.insert(subscriptionData);\n\n\t\tRocketChat.Livechat.stream.emit(room._id, {\n\t\t\ttype: 'agentData',\n\t\t\tdata: RocketChat.models.Users.getAgentInfo(agent.agentId)\n\t\t});\n\n\t\treturn room;\n\t},\n\t/* Guest Pool Queuing Method:\n\t *\n\t * An incomming livechat is created as an Inquiry\n\t * which is picked up from an agent.\n\t * An Inquiry is visible to all agents (TODO: in the correct department)\n     *\n\t * A room is still created with the initial message, but it is occupied by\n\t * only the client until paired with an agent\n\t */\n\t'Guest_Pool'(guest, message, roomInfo) {\n\t\tlet agents = RocketChat.Livechat.getOnlineAgents(guest.department);\n\n\t\tif (agents.count() === 0 && RocketChat.settings.get('Livechat_guest_pool_with_no_agents')) {\n\t\t\tagents = RocketChat.Livechat.getAgents(guest.department);\n\t\t}\n\n\t\tif (agents.count() === 0) {\n\t\t\tthrow new Meteor.Error('no-agent-online', 'Sorry, no online agents');\n\t\t}\n\n\t\tRocketChat.models.Rooms.updateLivechatRoomCount();\n\n\t\tconst agentIds = [];\n\n\t\tagents.forEach((agent) => {\n\t\t\tif (guest.department) {\n\t\t\t\tagentIds.push(agent.agentId);\n\t\t\t} else {\n\t\t\t\tagentIds.push(agent._id);\n\t\t\t}\n\t\t});\n\n\t\tconst inquiry = {\n\t\t\trid: message.rid,\n\t\t\tmessage: message.msg,\n\t\t\tname: guest.name || guest.username,\n\t\t\tts: new Date(),\n\t\t\tdepartment: guest.department,\n\t\t\tagents: agentIds,\n\t\t\tstatus: 'open',\n\t\t\tv: {\n\t\t\t\t_id: guest._id,\n\t\t\t\tusername: guest.username,\n\t\t\t\ttoken: message.token,\n\t\t\t\tstatus: guest.status || 'online'\n\t\t\t},\n\t\t\tt: 'l'\n\t\t};\n\t\tconst room = _.extend({\n\t\t\t_id: message.rid,\n\t\t\tmsgs: 1,\n\t\t\tlm: new Date(),\n\t\t\tfname: guest.name || guest.username,\n\t\t\t// usernames: [guest.username],\n\t\t\tt: 'l',\n\t\t\tts: new Date(),\n\t\t\tv: {\n\t\t\t\t_id: guest._id,\n\t\t\t\tusername: guest.username,\n\t\t\t\ttoken: message.token,\n\t\t\t\tstatus: guest.status\n\t\t\t},\n\t\t\tcl: false,\n\t\t\topen: true,\n\t\t\twaitingResponse: true\n\t\t}, roomInfo);\n\t\tRocketChat.models.LivechatInquiry.insert(inquiry);\n\t\tRocketChat.models.Rooms.insert(room);\n\n\t\treturn room;\n\t},\n\t'External'(guest, message, roomInfo, agent) {\n\t\treturn this['Least_Amount'](guest, message, roomInfo, agent); // eslint-disable-line\n\t}\n};\n","// Every minute check if office closed\nMeteor.setInterval(function() {\n\tif (RocketChat.settings.get('Livechat_enable_office_hours')) {\n\t\tif (RocketChat.models.LivechatOfficeHour.isOpeningTime()) {\n\t\t\tRocketChat.models.Users.openOffice();\n\t\t} else if (RocketChat.models.LivechatOfficeHour.isClosingTime()) {\n\t\t\tRocketChat.models.Users.closeOffice();\n\t\t}\n\t}\n}, 60000);\n","const gatewayURL = 'https://omni.rocket.chat';\n\nexport default {\n\tenable() {\n\t\tconst result = HTTP.call('POST', `${ gatewayURL }/facebook/enable`, {\n\t\t\theaders: {\n\t\t\t\t'authorization': `Bearer ${ RocketChat.settings.get('Livechat_Facebook_API_Key') }`,\n\t\t\t\t'content-type': 'application/json'\n\t\t\t},\n\t\t\tdata: {\n\t\t\t\turl: RocketChat.settings.get('Site_Url')\n\t\t\t}\n\t\t});\n\t\treturn result.data;\n\t},\n\n\tdisable() {\n\t\tconst result = HTTP.call('DELETE', `${ gatewayURL }/facebook/enable`, {\n\t\t\theaders: {\n\t\t\t\t'authorization': `Bearer ${ RocketChat.settings.get('Livechat_Facebook_API_Key') }`,\n\t\t\t\t'content-type': 'application/json'\n\t\t\t}\n\t\t});\n\t\treturn result.data;\n\t},\n\n\tlistPages() {\n\t\tconst result = HTTP.call('GET', `${ gatewayURL }/facebook/pages`, {\n\t\t\theaders: {\n\t\t\t\t'authorization': `Bearer ${ RocketChat.settings.get('Livechat_Facebook_API_Key') }`\n\t\t\t}\n\t\t});\n\t\treturn result.data;\n\t},\n\n\tsubscribe(pageId) {\n\t\tconst result = HTTP.call('POST', `${ gatewayURL }/facebook/page/${ pageId }/subscribe`, {\n\t\t\theaders: {\n\t\t\t\t'authorization': `Bearer ${ RocketChat.settings.get('Livechat_Facebook_API_Key') }`\n\t\t\t}\n\t\t});\n\t\treturn result.data;\n\t},\n\n\tunsubscribe(pageId) {\n\t\tconst result = HTTP.call('DELETE', `${ gatewayURL }/facebook/page/${ pageId }/subscribe`, {\n\t\t\theaders: {\n\t\t\t\t'authorization': `Bearer ${ RocketChat.settings.get('Livechat_Facebook_API_Key') }`\n\t\t\t}\n\t\t});\n\t\treturn result.data;\n\t},\n\n\treply({ page, token, text }) {\n\t\treturn HTTP.call('POST', `${ gatewayURL }/facebook/reply`, {\n\t\t\theaders: {\n\t\t\t\t'authorization': `Bearer ${ RocketChat.settings.get('Livechat_Facebook_API_Key') }`\n\t\t\t},\n\t\t\tdata: {\n\t\t\t\tpage,\n\t\t\t\ttoken,\n\t\t\t\ttext\n\t\t\t}\n\t\t});\n\t}\n};\n","import LivechatVisitors from './models/LivechatVisitors';\n\nRocketChat.callbacks.add('afterSaveMessage', function(message, room) {\n\t// skips this callback if the message was edited\n\tif (message.editedAt) {\n\t\treturn message;\n\t}\n\n\tif (!RocketChat.SMS.enabled) {\n\t\treturn message;\n\t}\n\n\t// only send the sms by SMS if it is a livechat room with SMS set to true\n\tif (!(typeof room.t !== 'undefined' && room.t === 'l' && room.sms && room.v && room.v.token)) {\n\t\treturn message;\n\t}\n\n\t// if the message has a token, it was sent from the visitor, so ignore it\n\tif (message.token) {\n\t\treturn message;\n\t}\n\n\t// if the message has a type means it is a special message (like the closing comment), so skips\n\tif (message.t) {\n\t\treturn message;\n\t}\n\n\tconst SMSService = RocketChat.SMS.getService(RocketChat.settings.get('SMS_Service'));\n\n\tif (!SMSService) {\n\t\treturn message;\n\t}\n\n\tconst visitor = LivechatVisitors.getVisitorByToken(room.v.token);\n\n\tif (!visitor || !visitor.phone || visitor.phone.length === 0) {\n\t\treturn message;\n\t}\n\n\tSMSService.send(room.sms.from, visitor.phone[0].phoneNumber, message.msg);\n\n\treturn message;\n\n}, RocketChat.callbacks.priority.LOW, 'sendMessageBySms');\n","/* globals UserPresenceMonitor */\n\nlet agentsHandler;\nlet monitorAgents = false;\nlet actionTimeout = 60000;\n\nconst onlineAgents = {\n\tusers: {},\n\tqueue: {},\n\n\tadd(userId) {\n\t\tif (this.queue[userId]) {\n\t\t\tclearTimeout(this.queue[userId]);\n\t\t\tdelete this.queue[userId];\n\t\t}\n\t\tthis.users[userId] = 1;\n\t},\n\n\tremove(userId, callback) {\n\t\tif (this.queue[userId]) {\n\t\t\tclearTimeout(this.queue[userId]);\n\t\t}\n\t\tthis.queue[userId] = setTimeout(Meteor.bindEnvironment(() => {\n\t\t\tcallback();\n\n\t\t\tdelete this.users[userId];\n\t\t\tdelete this.queue[userId];\n\t\t}), actionTimeout);\n\t},\n\n\texists(userId) {\n\t\treturn !!this.users[userId];\n\t}\n};\n\nfunction runAgentLeaveAction(userId) {\n\tconst action = RocketChat.settings.get('Livechat_agent_leave_action');\n\tif (action === 'close') {\n\t\treturn RocketChat.Livechat.closeOpenChats(userId, RocketChat.settings.get('Livechat_agent_leave_comment'));\n\t} else if (action === 'forward') {\n\t\treturn RocketChat.Livechat.forwardOpenChats(userId);\n\t}\n}\n\nRocketChat.settings.get('Livechat_agent_leave_action_timeout', function(key, value) {\n\tactionTimeout = value * 1000;\n});\n\nRocketChat.settings.get('Livechat_agent_leave_action', function(key, value) {\n\tmonitorAgents = value;\n\tif (value !== 'none') {\n\t\tif (!agentsHandler) {\n\t\t\tagentsHandler = RocketChat.models.Users.findOnlineAgents().observeChanges({\n\t\t\t\tadded(id) {\n\t\t\t\t\tonlineAgents.add(id);\n\t\t\t\t},\n\t\t\t\tchanged(id, fields) {\n\t\t\t\t\tif (fields.statusLivechat && fields.statusLivechat === 'not-available') {\n\t\t\t\t\t\tonlineAgents.remove(id, () => {\n\t\t\t\t\t\t\trunAgentLeaveAction(id);\n\t\t\t\t\t\t});\n\t\t\t\t\t} else {\n\t\t\t\t\t\tonlineAgents.add(id);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tremoved(id) {\n\t\t\t\t\tonlineAgents.remove(id, () => {\n\t\t\t\t\t\trunAgentLeaveAction(id);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t} else if (agentsHandler) {\n\t\tagentsHandler.stop();\n\t\tagentsHandler = null;\n\t}\n});\n\nUserPresenceMonitor.onSetUserStatus((user, status/*, statusConnection*/) => {\n\tif (!monitorAgents) {\n\t\treturn;\n\t}\n\tif (onlineAgents.exists(user._id)) {\n\t\tif (status === 'offline' || user.statusLivechat === 'not-available') {\n\t\t\tonlineAgents.remove(user._id, () => {\n\t\t\t\trunAgentLeaveAction(user._id);\n\t\t\t});\n\t\t}\n\t}\n});\n","import s from 'underscore.string';\n\nMeteor.publish('livechat:customFields', function(_id) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:customFields' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:customFields' }));\n\t}\n\n\tif (s.trim(_id)) {\n\t\treturn RocketChat.models.LivechatCustomField.find({ _id });\n\t}\n\n\treturn RocketChat.models.LivechatCustomField.find();\n\n});\n","Meteor.publish('livechat:departmentAgents', function(departmentId) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:departmentAgents' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-rooms')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:departmentAgents' }));\n\t}\n\n\treturn RocketChat.models.LivechatDepartmentAgents.find({ departmentId });\n});\n","Meteor.publish('livechat:externalMessages', function(roomId) {\n\treturn RocketChat.models.LivechatExternalMessage.findByRoomId(roomId);\n});\n","Meteor.publish('livechat:agents', function() {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:agents' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:agents' }));\n\t}\n\n\tconst self = this;\n\n\tconst handle = RocketChat.authz.getUsersInRole('livechat-agent').observeChanges({\n\t\tadded(id, fields) {\n\t\t\tself.added('agentUsers', id, fields);\n\t\t},\n\t\tchanged(id, fields) {\n\t\t\tself.changed('agentUsers', id, fields);\n\t\t},\n\t\tremoved(id) {\n\t\t\tself.removed('agentUsers', id);\n\t\t}\n\t});\n\n\tself.ready();\n\n\tself.onStop(function() {\n\t\thandle.stop();\n\t});\n});\n","Meteor.publish('livechat:appearance', function() {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:appearance' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:appearance' }));\n\t}\n\n\tconst query = {\n\t\t_id: {\n\t\t\t$in: [\n\t\t\t\t'Livechat_title',\n\t\t\t\t'Livechat_title_color',\n\t\t\t\t'Livechat_show_agent_email',\n\t\t\t\t'Livechat_display_offline_form',\n\t\t\t\t'Livechat_offline_form_unavailable',\n\t\t\t\t'Livechat_offline_message',\n\t\t\t\t'Livechat_offline_success_message',\n\t\t\t\t'Livechat_offline_title',\n\t\t\t\t'Livechat_offline_title_color',\n\t\t\t\t'Livechat_offline_email',\n\t\t\t\t'Livechat_conversation_finished_message',\n\t\t\t\t'Livechat_registration_form',\n\t\t\t\t'Livechat_name_field_registration_form',\n\t\t\t\t'Livechat_email_field_registration_form'\n\t\t\t]\n\t\t}\n\t};\n\n\tconst self = this;\n\n\tconst handle = RocketChat.models.Settings.find(query).observeChanges({\n\t\tadded(id, fields) {\n\t\t\tself.added('livechatAppearance', id, fields);\n\t\t},\n\t\tchanged(id, fields) {\n\t\t\tself.changed('livechatAppearance', id, fields);\n\t\t},\n\t\tremoved(id) {\n\t\t\tself.removed('livechatAppearance', id);\n\t\t}\n\t});\n\n\tthis.ready();\n\n\tthis.onStop(() => {\n\t\thandle.stop();\n\t});\n});\n","Meteor.publish('livechat:departments', function(_id) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:agents' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:agents' }));\n\t}\n\n\tif (_id !== undefined) {\n\t\treturn RocketChat.models.LivechatDepartment.findByDepartmentId(_id);\n\t} else {\n\t\treturn RocketChat.models.LivechatDepartment.find();\n\t}\n\n});\n","Meteor.publish('livechat:integration', function() {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:integration' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:integration' }));\n\t}\n\n\tconst self = this;\n\n\tconst handle = RocketChat.models.Settings.findByIds(['Livechat_webhookUrl', 'Livechat_secret_token', 'Livechat_webhook_on_close', 'Livechat_webhook_on_offline_msg', 'Livechat_webhook_on_visitor_message', 'Livechat_webhook_on_agent_message']).observeChanges({\n\t\tadded(id, fields) {\n\t\t\tself.added('livechatIntegration', id, fields);\n\t\t},\n\t\tchanged(id, fields) {\n\t\t\tself.changed('livechatIntegration', id, fields);\n\t\t},\n\t\tremoved(id) {\n\t\t\tself.removed('livechatIntegration', id);\n\t\t}\n\t});\n\n\tself.ready();\n\n\tself.onStop(function() {\n\t\thandle.stop();\n\t});\n});\n","Meteor.publish('livechat:managers', function() {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:managers' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-rooms')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:managers' }));\n\t}\n\n\tconst self = this;\n\n\tconst handle = RocketChat.authz.getUsersInRole('livechat-manager').observeChanges({\n\t\tadded(id, fields) {\n\t\t\tself.added('managerUsers', id, fields);\n\t\t},\n\t\tchanged(id, fields) {\n\t\t\tself.changed('managerUsers', id, fields);\n\t\t},\n\t\tremoved(id) {\n\t\t\tself.removed('managerUsers', id);\n\t\t}\n\t});\n\n\tself.ready();\n\n\tself.onStop(function() {\n\t\thandle.stop();\n\t});\n});\n","Meteor.publish('livechat:rooms', function(filter = {}, offset = 0, limit = 20) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:rooms' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-rooms')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:rooms' }));\n\t}\n\n\tcheck(filter, {\n\t\tname: Match.Maybe(String), // room name to filter\n\t\tagent: Match.Maybe(String), // agent _id who is serving\n\t\tstatus: Match.Maybe(String), // either 'opened' or 'closed'\n\t\tfrom: Match.Maybe(Date),\n\t\tto: Match.Maybe(Date)\n\t});\n\n\tconst query = {};\n\tif (filter.name) {\n\t\tquery.label = new RegExp(filter.name, 'i');\n\t}\n\tif (filter.agent) {\n\t\tquery['servedBy._id'] = filter.agent;\n\t}\n\tif (filter.status) {\n\t\tif (filter.status === 'opened') {\n\t\t\tquery.open = true;\n\t\t} else {\n\t\t\tquery.open = { $exists: false };\n\t\t}\n\t}\n\tif (filter.from) {\n\t\tquery.ts = {\n\t\t\t$gte: filter.from\n\t\t};\n\t}\n\tif (filter.to) {\n\t\tfilter.to.setDate(filter.to.getDate() + 1);\n\t\tfilter.to.setSeconds(filter.to.getSeconds() - 1);\n\n\t\tif (!query.ts) {\n\t\t\tquery.ts = {};\n\t\t}\n\t\tquery.ts.$lte = filter.to;\n\t}\n\n\tconst self = this;\n\n\tconst handle = RocketChat.models.Rooms.findLivechat(query, offset, limit).observeChanges({\n\t\tadded(id, fields) {\n\t\t\tself.added('livechatRoom', id, fields);\n\t\t},\n\t\tchanged(id, fields) {\n\t\t\tself.changed('livechatRoom', id, fields);\n\t\t},\n\t\tremoved(id) {\n\t\t\tself.removed('livechatRoom', id);\n\t\t}\n\t});\n\n\tthis.ready();\n\n\tthis.onStop(() => {\n\t\thandle.stop();\n\t});\n});\n","Meteor.publish('livechat:queue', function() {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:queue' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:queue' }));\n\t}\n\n\t// let sort = { count: 1, sort: 1, username: 1 };\n\t// let onlineUsers = {};\n\n\t// let handleUsers = RocketChat.models.Users.findOnlineAgents().observeChanges({\n\t// \tadded(id, fields) {\n\t// \t\tonlineUsers[fields.username] = 1;\n\t// \t\t// this.added('livechatQueueUser', id, fields);\n\t// \t},\n\t// \tchanged(id, fields) {\n\t// \t\tonlineUsers[fields.username] = 1;\n\t// \t\t// this.changed('livechatQueueUser', id, fields);\n\t// \t},\n\t// \tremoved(id) {\n\t// \t\tthis.removed('livechatQueueUser', id);\n\t// \t}\n\t// });\n\n\tconst self = this;\n\n\tconst handleDepts = RocketChat.models.LivechatDepartmentAgents.findUsersInQueue().observeChanges({\n\t\tadded(id, fields) {\n\t\t\tself.added('livechatQueueUser', id, fields);\n\t\t},\n\t\tchanged(id, fields) {\n\t\t\tself.changed('livechatQueueUser', id, fields);\n\t\t},\n\t\tremoved(id) {\n\t\t\tself.removed('livechatQueueUser', id);\n\t\t}\n\t});\n\n\tthis.ready();\n\n\tthis.onStop(() => {\n\t\t// handleUsers.stop();\n\t\thandleDepts.stop();\n\t});\n});\n","Meteor.publish('livechat:triggers', function(_id) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:triggers' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:triggers' }));\n\t}\n\n\tif (_id !== undefined) {\n\t\treturn RocketChat.models.LivechatTrigger.findById(_id);\n\t} else {\n\t\treturn RocketChat.models.LivechatTrigger.find();\n\t}\n});\n","Meteor.publish('livechat:visitorHistory', function({ rid: roomId }) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:visitorHistory' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:visitorHistory' }));\n\t}\n\n\tconst room = RocketChat.models.Rooms.findOneById(roomId);\n\n\tconst user = RocketChat.models.Users.findOneById(this.userId);\n\n\tif (room.usernames.indexOf(user.username) === -1) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:visitorHistory' }));\n\t}\n\n\tconst self = this;\n\n\tif (room && room.v && room.v._id) {\n\t\tconst handle = RocketChat.models.Rooms.findByVisitorId(room.v._id).observeChanges({\n\t\t\tadded(id, fields) {\n\t\t\t\tself.added('visitor_history', id, fields);\n\t\t\t},\n\t\t\tchanged(id, fields) {\n\t\t\t\tself.changed('visitor_history', id, fields);\n\t\t\t},\n\t\t\tremoved(id) {\n\t\t\t\tself.removed('visitor_history', id);\n\t\t\t}\n\t\t});\n\n\t\tself.ready();\n\n\t\tself.onStop(function() {\n\t\t\thandle.stop();\n\t\t});\n\t} else {\n\t\tself.ready();\n\t}\n});\n","import LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.publish('livechat:visitorInfo', function({ rid: roomId }) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:visitorInfo' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:visitorInfo' }));\n\t}\n\n\tconst room = RocketChat.models.Rooms.findOneById(roomId);\n\n\tif (room && room.v && room.v._id) {\n\t\treturn LivechatVisitors.findById(room.v._id);\n\t} else {\n\t\treturn this.ready();\n\t}\n});\n","Meteor.publish('livechat:visitorPageVisited', function({ rid: roomId }) {\n\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:visitorPageVisited' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:visitorPageVisited' }));\n\t}\n\n\tconst self = this;\n\tconst room = RocketChat.models.Rooms.findOneById(roomId);\n\n\tif (room) {\n\t\tconst handle = RocketChat.models.Messages.findByRoomIdAndType(room._id, 'livechat_navigation_history').observeChanges({\n\t\t\tadded(id, fields) {\n\t\t\t\tself.added('visitor_navigation_history', id, fields);\n\t\t\t},\n\t\t\tchanged(id, fields) {\n\t\t\t\tself.changed('visitor_navigation_history', id, fields);\n\t\t\t},\n\t\t\tremoved(id) {\n\t\t\t\tself.removed('visitor_navigation_history', id);\n\t\t\t}\n\t\t});\n\n\t\tself.ready();\n\n\t\tself.onStop(function() {\n\t\t\thandle.stop();\n\t\t});\n\t} else {\n\t\tself.ready();\n\t}\n});\n","Meteor.publish('livechat:inquiry', function() {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:inquiry' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:inquiry' }));\n\t}\n\n\tconst query = {\n\t\tagents: this.userId,\n\t\tstatus: 'open'\n\t};\n\n\treturn RocketChat.models.LivechatInquiry.find(query);\n});\n","Meteor.publish('livechat:officeHour', function() {\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:agents' }));\n\t}\n\n\treturn RocketChat.models.LivechatOfficeHour.find();\n});\n","import '../imports/server/rest/departments.js';\nimport '../imports/server/rest/facebook.js';\nimport '../imports/server/rest/sms.js';\nimport '../imports/server/rest/users.js';\nimport '../imports/server/rest/messages.js';\nimport '../imports/server/rest/visitors.js';\n","import _ from 'underscore';\n\nMeteor.startup(() => {\n\tconst roles = _.pluck(RocketChat.models.Roles.find().fetch(), 'name');\n\tif (roles.indexOf('livechat-agent') === -1) {\n\t\tRocketChat.models.Roles.createOrUpdate('livechat-agent');\n\t}\n\tif (roles.indexOf('livechat-manager') === -1) {\n\t\tRocketChat.models.Roles.createOrUpdate('livechat-manager');\n\t}\n\tif (roles.indexOf('livechat-guest') === -1) {\n\t\tRocketChat.models.Roles.createOrUpdate('livechat-guest');\n\t}\n\tif (RocketChat.models && RocketChat.models.Permissions) {\n\t\tRocketChat.models.Permissions.createOrUpdate('view-l-room', ['livechat-agent', 'livechat-manager', 'admin']);\n\t\tRocketChat.models.Permissions.createOrUpdate('view-livechat-manager', ['livechat-manager', 'admin']);\n\t\tRocketChat.models.Permissions.createOrUpdate('view-livechat-rooms', ['livechat-manager', 'admin']);\n\t\tRocketChat.models.Permissions.createOrUpdate('close-livechat-room', ['livechat-agent', 'livechat-manager', 'admin']);\n\t\tRocketChat.models.Permissions.createOrUpdate('close-others-livechat-room', ['livechat-manager', 'admin']);\n\t\tRocketChat.models.Permissions.createOrUpdate('save-others-livechat-room-info', ['livechat-manager']);\n\t}\n});\n","RocketChat.MessageTypes.registerType({\n\tid: 'livechat_navigation_history',\n\tsystem: true,\n\tmessage: 'New_visitor_navigation',\n\tdata(message) {\n\t\tif (!message.navigation || !message.navigation.page) {\n\t\t\treturn;\n\t\t}\n\t\treturn {\n\t\t\thistory: `${ (message.navigation.page.title ? `${ message.navigation.page.title } - ` : '') + message.navigation.page.location.href }`\n\t\t};\n\t}\n});\n\nRocketChat.MessageTypes.registerType({\n\tid: 'livechat_video_call',\n\tsystem: true,\n\tmessage: 'New_videocall_request'\n});\n\nRocketChat.actionLinks.register('createLivechatCall', function(message, params, instance) {\n\tif (Meteor.isClient) {\n\t\tinstance.tabBar.open('video');\n\t}\n});\n\nRocketChat.actionLinks.register('denyLivechatCall', function(message/*, params*/) {\n\tif (Meteor.isServer) {\n\t\tconst user = Meteor.user();\n\n\t\tRocketChat.models.Messages.createWithTypeRoomIdMessageAndUser('command', message.rid, 'endCall', user);\n\t\tRocketChat.Notifications.notifyRoom(message.rid, 'deleteMessage', { _id: message._id });\n\n\t\tconst language = user.language || RocketChat.settings.get('language') || 'en';\n\n\t\tRocketChat.Livechat.closeRoom({\n\t\t\tuser,\n\t\t\troom: RocketChat.models.Rooms.findOneById(message.rid),\n\t\t\tcomment: TAPi18n.__('Videocall_declined', { lng: language })\n\t\t});\n\t\tMeteor.defer(() => {\n\t\t\tRocketChat.models.Messages.setHiddenById(message._id);\n\t\t});\n\t}\n});\n","/* globals openRoom, LivechatInquiry */\nimport {RoomSettingsEnum, RoomTypeConfig, RoomTypeRouteConfig, UiTextContext} from 'meteor/rocketchat:lib';\n\nclass LivechatRoomRoute extends RoomTypeRouteConfig {\n\tconstructor() {\n\t\tsuper({\n\t\t\tname: 'live',\n\t\t\tpath: '/live/:id'\n\t\t});\n\t}\n\n\taction(params) {\n\t\topenRoom('l', params.id);\n\t}\n\n\tlink(sub) {\n\t\treturn {\n\t\t\tid: sub.rid\n\t\t};\n\t}\n}\n\nclass LivechatRoomType extends RoomTypeConfig {\n\tconstructor() {\n\t\tsuper({\n\t\t\tidentifier: 'l',\n\t\t\torder: 5,\n\t\t\ticon: 'livechat',\n\t\t\tlabel: 'Livechat',\n\t\t\troute: new LivechatRoomRoute()\n\t\t});\n\n\t\tthis.notSubscribedTpl = {\n\t\t\ttemplate: 'livechatNotSubscribed'\n\t\t};\n\t}\n\n\tfindRoom(identifier) {\n\t\treturn ChatRoom.findOne({_id: identifier});\n\t}\n\n\troomName(roomData) {\n\t\treturn roomData.name || roomData.fname || roomData.label;\n\t}\n\n\tcondition() {\n\t\treturn RocketChat.settings.get('Livechat_enabled') && RocketChat.authz.hasAllPermission('view-l-room');\n\t}\n\n\tcanSendMessage(roomId) {\n\t\tconst room = ChatRoom.findOne({_id: roomId}, {fields: {open: 1}});\n\t\treturn room && room.open === true;\n\t}\n\n\tgetUserStatus(roomId) {\n\t\tconst room = Session.get(`roomData${ roomId }`);\n\t\tif (room) {\n\t\t\treturn room.v && room.v.status;\n\t\t}\n\n\t\tconst inquiry = LivechatInquiry.findOne({ rid: roomId });\n\t\treturn inquiry && inquiry.v && inquiry.v.status;\n\t}\n\n\tallowRoomSettingChange(room, setting) {\n\t\tswitch (setting) {\n\t\t\tcase RoomSettingsEnum.JOIN_CODE:\n\t\t\t\treturn false;\n\t\t\tdefault:\n\t\t\t\treturn true;\n\t\t}\n\t}\n\n\tgetUiText(context) {\n\t\tswitch (context) {\n\t\t\tcase UiTextContext.HIDE_WARNING:\n\t\t\t\treturn 'Hide_Livechat_Warning';\n\t\t\tcase UiTextContext.LEAVE_WARNING:\n\t\t\t\treturn 'Hide_Livechat_Warning';\n\t\t\tdefault:\n\t\t\t\treturn '';\n\t\t}\n\t}\n}\n\nRocketChat.roomTypes.add(new LivechatRoomType());\n","Meteor.startup(function() {\n\tRocketChat.settings.addGroup('Livechat');\n\n\tRocketChat.settings.add('Livechat_enabled', false, { type: 'boolean', group: 'Livechat', public: true });\n\n\tRocketChat.settings.add('Livechat_title', 'Rocket.Chat', { type: 'string', group: 'Livechat', public: true });\n\tRocketChat.settings.add('Livechat_title_color', '#C1272D', {\n\t\ttype: 'color',\n\t\teditor: 'color',\n\t\tallowedTypes: ['color', 'expression'],\n\t\tgroup: 'Livechat',\n\t\tpublic: true\n\t});\n\n\tRocketChat.settings.add('Livechat_display_offline_form', true, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Offline',\n\t\ti18nLabel: 'Display_offline_form'\n\t});\n\n\tRocketChat.settings.add('Livechat_validate_offline_email', true, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Offline',\n\t\ti18nLabel: 'Validate_email_address'\n\t});\n\n\tRocketChat.settings.add('Livechat_offline_form_unavailable', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Offline',\n\t\ti18nLabel: 'Offline_form_unavailable_message'\n\t});\n\n\tRocketChat.settings.add('Livechat_offline_title', 'Leave a message', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Offline',\n\t\ti18nLabel: 'Title'\n\t});\n\tRocketChat.settings.add('Livechat_offline_title_color', '#666666', {\n\t\ttype: 'color',\n\t\teditor: 'color',\n\t\tallowedTypes: ['color', 'expression'],\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Offline',\n\t\ti18nLabel: 'Color'\n\t});\n\tRocketChat.settings.add('Livechat_offline_message', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Offline',\n\t\ti18nLabel: 'Instructions',\n\t\ti18nDescription: 'Instructions_to_your_visitor_fill_the_form_to_send_a_message'\n\t});\n\tRocketChat.settings.add('Livechat_offline_email', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\ti18nLabel: 'Email_address_to_send_offline_messages',\n\t\tsection: 'Offline'\n\t});\n\tRocketChat.settings.add('Livechat_offline_success_message', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Offline',\n\t\ti18nLabel: 'Offline_success_message'\n\t});\n\n\tRocketChat.settings.add('Livechat_allow_switching_departments', true, { type: 'boolean', group: 'Livechat', public: true, i18nLabel: 'Allow_switching_departments' });\n\tRocketChat.settings.add('Livechat_show_agent_email', true, { type: 'boolean', group: 'Livechat', public: true, i18nLabel: 'Show_agent_email' });\n\n\tRocketChat.settings.add('Livechat_conversation_finished_message', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Conversation_finished_message'\n\t});\n\n\tRocketChat.settings.add('Livechat_registration_form', true, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Show_preregistration_form'\n\t});\n\n\tRocketChat.settings.add('Livechat_name_field_registration_form', true, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Show_name_field'\n\t});\n\n\tRocketChat.settings.add('Livechat_email_field_registration_form', true, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Show_email_field'\n\t});\n\n\tRocketChat.settings.add('Livechat_guest_count', 1, { type: 'int', group: 'Livechat' });\n\n\tRocketChat.settings.add('Livechat_Room_Count', 1, {\n\t\ttype: 'int',\n\t\tgroup: 'Livechat',\n\t\ti18nLabel: 'Livechat_room_count'\n\t});\n\n\tRocketChat.settings.add('Livechat_agent_leave_action', 'none', {\n\t\ttype: 'select',\n\t\tgroup: 'Livechat',\n\t\tvalues: [\n\t\t\t{ key: 'none', i18nLabel: 'None' },\n\t\t\t{ key: 'forward', i18nLabel: 'Forward' },\n\t\t\t{ key: 'close', i18nLabel: 'Close' }\n\t\t],\n\t\ti18nLabel: 'How_to_handle_open_sessions_when_agent_goes_offline'\n\t});\n\n\tRocketChat.settings.add('Livechat_agent_leave_action_timeout', 60, {\n\t\ttype: 'int',\n\t\tgroup: 'Livechat',\n\t\tenableQuery: { _id: 'Livechat_agent_leave_action', value: { $ne: 'none' } },\n\t\ti18nLabel: 'How_long_to_wait_after_agent_goes_offline',\n\t\ti18nDescription: 'Time_in_seconds'\n\t});\n\n\tRocketChat.settings.add('Livechat_agent_leave_comment', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tenableQuery: { _id: 'Livechat_agent_leave_action', value: 'close' },\n\t\ti18nLabel: 'Comment_to_leave_on_closing_session'\n\t});\n\n\tRocketChat.settings.add('Livechat_webhookUrl', false, {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tsection: 'CRM_Integration',\n\t\ti18nLabel: 'Webhook_URL'\n\t});\n\n\tRocketChat.settings.add('Livechat_secret_token', false, {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tsection: 'CRM_Integration',\n\t\ti18nLabel: 'Secret_token'\n\t});\n\n\tRocketChat.settings.add('Livechat_webhook_on_close', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tsection: 'CRM_Integration',\n\t\ti18nLabel: 'Send_request_on_chat_close'\n\t});\n\n\tRocketChat.settings.add('Livechat_webhook_on_offline_msg', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tsection: 'CRM_Integration',\n\t\ti18nLabel: 'Send_request_on_offline_messages'\n\t});\n\n\tRocketChat.settings.add('Livechat_webhook_on_visitor_message', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tsection: 'CRM_Integration',\n\t\ti18nLabel: 'Send_request_on_visitor_message'\n\t});\n\n\tRocketChat.settings.add('Livechat_webhook_on_agent_message', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tsection: 'CRM_Integration',\n\t\ti18nLabel: 'Send_request_on_agent_message'\n\t});\n\n\tRocketChat.settings.add('Send_visitor_navigation_history_livechat_webhook_request', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tsection: 'CRM_Integration',\n\t\ti18nLabel: 'Send_visitor_navigation_history_on_request',\n\t\ti18nDescription: 'Feature_Depends_on_Livechat_Visitor_navigation_as_a_message_to_be_enabled',\n\t\tenableQuery: { _id: 'Livechat_Visitor_navigation_as_a_message', value: true }\n\t});\n\n\tRocketChat.settings.add('Livechat_webhook_on_capture', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tsection: 'CRM_Integration',\n\t\ti18nLabel: 'Send_request_on_lead_capture'\n\t});\n\n\tRocketChat.settings.add('Livechat_lead_email_regex', '\\\\b[A-Z0-9._%+-]+@(?:[A-Z0-9-]+\\\\.)+[A-Z]{2,4}\\\\b', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tsection: 'CRM_Integration',\n\t\ti18nLabel: 'Lead_capture_email_regex'\n\t});\n\n\tRocketChat.settings.add('Livechat_lead_phone_regex', '((?:\\\\([0-9]{1,3}\\\\)|[0-9]{2})[ \\\\-]*?[0-9]{4,5}(?:[\\\\-\\\\s\\\\_]{1,2})?[0-9]{4}(?:(?=[^0-9])|$)|[0-9]{4,5}(?:[\\\\-\\\\s\\\\_]{1,2})?[0-9]{4}(?:(?=[^0-9])|$))', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tsection: 'CRM_Integration',\n\t\ti18nLabel: 'Lead_capture_phone_regex'\n\t});\n\n\tRocketChat.settings.add('Livechat_Knowledge_Enabled', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tsection: 'Knowledge_Base',\n\t\tpublic: true,\n\t\ti18nLabel: 'Enabled'\n\t});\n\n\tRocketChat.settings.add('Livechat_Knowledge_Apiai_Key', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tsection: 'Knowledge_Base',\n\t\tpublic: true,\n\t\ti18nLabel: 'Apiai_Key'\n\t});\n\n\tRocketChat.settings.add('Livechat_Knowledge_Apiai_Language', 'en', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tsection: 'Knowledge_Base',\n\t\tpublic: true,\n\t\ti18nLabel: 'Apiai_Language'\n\t});\n\n\tRocketChat.settings.add('Livechat_history_monitor_type', 'url', {\n\t\ttype: 'select',\n\t\tgroup: 'Livechat',\n\t\ti18nLabel: 'Monitor_history_for_changes_on',\n\t\tvalues: [\n\t\t\t{ key: 'url', i18nLabel: 'Page_URL' },\n\t\t\t{ key: 'title', i18nLabel: 'Page_title' }\n\t\t]\n\t});\n\n\tRocketChat.settings.add('Livechat_Visitor_navigation_as_a_message', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Send_Visitor_navigation_history_as_a_message'\n\t});\n\n\tRocketChat.settings.add('Livechat_enable_office_hours', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Office_hours_enabled'\n\t});\n\n\tRocketChat.settings.add('Livechat_continuous_sound_notification_new_livechat_room', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Continuous_sound_notifications_for_new_livechat_room'\n\t});\n\n\tRocketChat.settings.add('Livechat_videocall_enabled', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Videocall_enabled',\n\t\ti18nDescription: 'Beta_feature_Depends_on_Video_Conference_to_be_enabled',\n\t\tenableQuery: { _id: 'Jitsi_Enabled', value: true }\n\t});\n\n\tRocketChat.settings.add('Livechat_enable_transcript', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Transcript_Enabled'\n\t});\n\n\tRocketChat.settings.add('Livechat_transcript_message', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Transcript_message',\n\t\tenableQuery: { _id: 'Livechat_enable_transcript', value: true }\n\t});\n\n\tRocketChat.settings.add('Livechat_open_inquiery_show_connecting', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Livechat_open_inquiery_show_connecting',\n\t\tenableQuery: { _id: 'Livechat_Routing_Method', value: 'Guest_Pool' }\n\t});\n\n\tRocketChat.settings.add('Livechat_AllowedDomainsList', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Livechat_AllowedDomainsList',\n\t\ti18nDescription: 'Domains_allowed_to_embed_the_livechat_widget'\n\t});\n\n\tRocketChat.settings.add('Livechat_Facebook_Enabled', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tsection: 'Facebook'\n\t});\n\n\tRocketChat.settings.add('Livechat_Facebook_API_Key', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tsection: 'Facebook',\n\t\ti18nDescription: 'If_you_dont_have_one_send_an_email_to_omni_rocketchat_to_get_yours'\n\t});\n\n\tRocketChat.settings.add('Livechat_Facebook_API_Secret', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tsection: 'Facebook',\n\t\ti18nDescription: 'If_you_dont_have_one_send_an_email_to_omni_rocketchat_to_get_yours'\n\t});\n\n\tRocketChat.settings.add('Livechat_RDStation_Token', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: false,\n\t\tsection: 'RD Station',\n\t\ti18nLabel: 'RDStation_Token'\n\t});\n\n\tRocketChat.settings.add('Livechat_Routing_Method', 'Least_Amount', {\n\t\ttype: 'select',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Routing',\n\t\tvalues: [\n\t\t\t{key: 'External', i18nLabel: 'External_Service'},\n\t\t\t{key: 'Least_Amount', i18nLabel: 'Least_Amount'},\n\t\t\t{key: 'Guest_Pool', i18nLabel: 'Guest_Pool'}\n\t\t]\n\t});\n\n\tRocketChat.settings.add('Livechat_guest_pool_with_no_agents', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tsection: 'Routing',\n\t\ti18nLabel: 'Accept_with_no_online_agents',\n\t\ti18nDescription: 'Accept_incoming_livechat_requests_even_if_there_are_no_online_agents',\n\t\tenableQuery: { _id: 'Livechat_Routing_Method', value: 'Guest_Pool' }\n\t});\n\n\tRocketChat.settings.add('Livechat_show_queue_list_link', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Routing',\n\t\ti18nLabel: 'Show_queue_list_to_all_agents',\n\t\tenableQuery: { _id: 'Livechat_Routing_Method', value: { $ne: 'External' } }\n\t});\n\n\tRocketChat.settings.add('Livechat_External_Queue_URL', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: false,\n\t\tsection: 'Routing',\n\t\ti18nLabel: 'External_Queue_Service_URL',\n\t\ti18nDescription: 'For_more_details_please_check_our_docs',\n\t\tenableQuery: { _id: 'Livechat_Routing_Method', value: 'External' }\n\t});\n\n\tRocketChat.settings.add('Livechat_External_Queue_Token', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: false,\n\t\tsection: 'Routing',\n\t\ti18nLabel: 'Secret_token',\n\t\tenableQuery: { _id: 'Livechat_Routing_Method', value: 'External' }\n\t});\n});\n","RocketChat.API.v1.addRoute('livechat/department', { authRequired: true }, {\n\tget() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\treturn RocketChat.API.v1.success({\n\t\t\tdepartments: RocketChat.models.LivechatDepartment.find().fetch()\n\t\t});\n\t},\n\tpost() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\ttry {\n\t\t\tcheck(this.bodyParams, {\n\t\t\t\tdepartment: Object,\n\t\t\t\tagents: Array\n\t\t\t});\n\n\t\t\tconst department = RocketChat.Livechat.saveDepartment(null, this.bodyParams.department, this.bodyParams.agents);\n\n\t\t\tif (department) {\n\t\t\t\treturn RocketChat.API.v1.success({\n\t\t\t\t\tdepartment,\n\t\t\t\t\tagents: RocketChat.models.LivechatDepartmentAgents.find({ departmentId: department._id }).fetch()\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tRocketChat.API.v1.failure();\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e);\n\t\t}\n\t}\n});\n\nRocketChat.API.v1.addRoute('livechat/department/:_id', { authRequired: true }, {\n\tget() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\t_id: String\n\t\t\t});\n\n\t\t\treturn RocketChat.API.v1.success({\n\t\t\t\tdepartment: RocketChat.models.LivechatDepartment.findOneById(this.urlParams._id),\n\t\t\t\tagents: RocketChat.models.LivechatDepartmentAgents.find({ departmentId: this.urlParams._id }).fetch()\n\t\t\t});\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t},\n\tput() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\t_id: String\n\t\t\t});\n\n\t\t\tcheck(this.bodyParams, {\n\t\t\t\tdepartment: Object,\n\t\t\t\tagents: Array\n\t\t\t});\n\n\t\t\tif (RocketChat.Livechat.saveDepartment(this.urlParams._id, this.bodyParams.department, this.bodyParams.agents)) {\n\t\t\t\treturn RocketChat.API.v1.success({\n\t\t\t\t\tdepartment: RocketChat.models.LivechatDepartment.findOneById(this.urlParams._id),\n\t\t\t\t\tagents: RocketChat.models.LivechatDepartmentAgents.find({ departmentId: this.urlParams._id }).fetch()\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn RocketChat.API.v1.failure();\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t},\n\tdelete() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\t_id: String\n\t\t\t});\n\n\t\t\tif (RocketChat.Livechat.removeDepartment(this.urlParams._id)) {\n\t\t\t\treturn RocketChat.API.v1.success();\n\t\t\t}\n\n\t\t\treturn RocketChat.API.v1.failure();\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t}\n});\n","import crypto from 'crypto';\n\nimport LivechatVisitors from '../../../server/models/LivechatVisitors';\n\n/**\n * @api {post} /livechat/facebook Send Facebook message\n * @apiName Facebook\n * @apiGroup Livechat\n *\n * @apiParam {String} mid Facebook message id\n * @apiParam {String} page Facebook pages id\n * @apiParam {String} token Facebook user's token\n * @apiParam {String} first_name Facebook user's first name\n * @apiParam {String} last_name Facebook user's last name\n * @apiParam {String} [text] Facebook message text\n * @apiParam {String} [attachments] Facebook message attachments\n */\nRocketChat.API.v1.addRoute('livechat/facebook', {\n\tpost() {\n\t\tif (!this.bodyParams.text && !this.bodyParams.attachments) {\n\t\t\treturn {\n\t\t\t\tsuccess: false\n\t\t\t};\n\t\t}\n\n\t\tif (!this.request.headers['x-hub-signature']) {\n\t\t\treturn {\n\t\t\t\tsuccess: false\n\t\t\t};\n\t\t}\n\n\t\tif (!RocketChat.settings.get('Livechat_Facebook_Enabled')) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: 'Integration disabled'\n\t\t\t};\n\t\t}\n\n\t\t// validate if request come from omni\n\t\tconst signature = crypto.createHmac('sha1', RocketChat.settings.get('Livechat_Facebook_API_Secret')).update(JSON.stringify(this.request.body)).digest('hex');\n\t\tif (this.request.headers['x-hub-signature'] !== `sha1=${ signature }`) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: 'Invalid signature'\n\t\t\t};\n\t\t}\n\n\t\tconst sendMessage = {\n\t\t\tmessage: {\n\t\t\t\t_id: this.bodyParams.mid\n\t\t\t},\n\t\t\troomInfo: {\n\t\t\t\tfacebook: {\n\t\t\t\t\tpage: this.bodyParams.page\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\t\tlet visitor = LivechatVisitors.getVisitorByToken(this.bodyParams.token);\n\t\tif (visitor) {\n\t\t\tconst rooms = RocketChat.models.Rooms.findOpenByVisitorToken(visitor.token).fetch();\n\t\t\tif (rooms && rooms.length > 0) {\n\t\t\t\tsendMessage.message.rid = rooms[0]._id;\n\t\t\t} else {\n\t\t\t\tsendMessage.message.rid = Random.id();\n\t\t\t}\n\t\t\tsendMessage.message.token = visitor.token;\n\t\t} else {\n\t\t\tsendMessage.message.rid = Random.id();\n\t\t\tsendMessage.message.token = this.bodyParams.token;\n\n\t\t\tconst userId = RocketChat.Livechat.registerGuest({\n\t\t\t\ttoken: sendMessage.message.token,\n\t\t\t\tname: `${ this.bodyParams.first_name } ${ this.bodyParams.last_name }`\n\t\t\t});\n\n\t\t\tvisitor = RocketChat.models.Users.findOneById(userId);\n\t\t}\n\n\t\tsendMessage.message.msg = this.bodyParams.text;\n\t\tsendMessage.guest = visitor;\n\n\t\ttry {\n\t\t\treturn {\n\t\t\t\tsucess: true,\n\t\t\t\tmessage: RocketChat.Livechat.sendMessage(sendMessage)\n\t\t\t};\n\t\t} catch (e) {\n\t\t\tconsole.error('Error using Facebook ->', e);\n\t\t}\n\t}\n});\n","import LivechatVisitors from '../../../server/models/LivechatVisitors';\n\nRocketChat.API.v1.addRoute('livechat/messages', { authRequired: true }, {\n\tpost() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\tif (!this.bodyParams.visitor) {\n\t\t\treturn RocketChat.API.v1.failure('Body param \"visitor\" is required');\n\t\t}\n\t\tif (!this.bodyParams.visitor.token) {\n\t\t\treturn RocketChat.API.v1.failure('Body param \"visitor.token\" is required');\n\t\t}\n\t\tif (!this.bodyParams.messages) {\n\t\t\treturn RocketChat.API.v1.failure('Body param \"messages\" is required');\n\t\t}\n\t\tif (!(this.bodyParams.messages instanceof Array)) {\n\t\t\treturn RocketChat.API.v1.failure('Body param \"messages\" is not an array');\n\t\t}\n\t\tif (this.bodyParams.messages.length === 0) {\n\t\t\treturn RocketChat.API.v1.failure('Body param \"messages\" is empty');\n\t\t}\n\n\t\tconst visitorToken = this.bodyParams.visitor.token;\n\n\t\tlet visitor = LivechatVisitors.getVisitorByToken(visitorToken);\n\t\tlet rid;\n\t\tif (visitor) {\n\t\t\tconst rooms = RocketChat.models.Rooms.findOpenByVisitorToken(visitorToken).fetch();\n\t\t\tif (rooms && rooms.length > 0) {\n\t\t\t\trid = rooms[0]._id;\n\t\t\t} else {\n\t\t\t\trid = Random.id();\n\t\t\t}\n\t\t} else {\n\t\t\trid = Random.id();\n\t\t\tconst visitorId = RocketChat.Livechat.registerGuest(this.bodyParams.visitor);\n\t\t\tvisitor = LivechatVisitors.findOneById(visitorId);\n\t\t}\n\n\t\tconst sentMessages = this.bodyParams.messages.map((message) => {\n\t\t\tconst sendMessage = {\n\t\t\t\tguest: visitor,\n\t\t\t\tmessage: {\n\t\t\t\t\t_id: Random.id(),\n\t\t\t\t\trid,\n\t\t\t\t\ttoken: visitorToken,\n\t\t\t\t\tmsg: message.msg\n\t\t\t\t}\n\t\t\t};\n\t\t\tconst sentMessage = RocketChat.Livechat.sendMessage(sendMessage);\n\t\t\treturn {\n\t\t\t\tusername: sentMessage.u.username,\n\t\t\t\tmsg: sentMessage.msg,\n\t\t\t\tts: sentMessage.ts\n\t\t\t};\n\t\t});\n\n\t\treturn RocketChat.API.v1.success({\n\t\t\tmessages: sentMessages\n\t\t});\n\t}\n});\n","import LivechatVisitors from '../../../server/models/LivechatVisitors';\n\nRocketChat.API.v1.addRoute('livechat/sms-incoming/:service', {\n\tpost() {\n\t\tconst SMSService = RocketChat.SMS.getService(this.urlParams.service);\n\n\t\tconst sms = SMSService.parse(this.bodyParams);\n\n\t\tlet visitor = LivechatVisitors.findOneVisitorByPhone(sms.from);\n\n\t\tconst sendMessage = {\n\t\t\tmessage: {\n\t\t\t\t_id: Random.id()\n\t\t\t},\n\t\t\troomInfo: {\n\t\t\t\tsms: {\n\t\t\t\t\tfrom: sms.to\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\n\t\tif (visitor) {\n\t\t\tconst rooms = RocketChat.models.Rooms.findOpenByVisitorToken(visitor.token).fetch();\n\n\t\t\tif (rooms && rooms.length > 0) {\n\t\t\t\tsendMessage.message.rid = rooms[0]._id;\n\t\t\t} else {\n\t\t\t\tsendMessage.message.rid = Random.id();\n\t\t\t}\n\t\t\tsendMessage.message.token = visitor.token;\n\t\t} else {\n\t\t\tsendMessage.message.rid = Random.id();\n\t\t\tsendMessage.message.token = Random.id();\n\n\t\t\tconst visitorId = RocketChat.Livechat.registerGuest({\n\t\t\t\tusername: sms.from.replace(/[^0-9]/g, ''),\n\t\t\t\ttoken: sendMessage.message.token,\n\t\t\t\tphone: {\n\t\t\t\t\tnumber: sms.from\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tvisitor = LivechatVisitors.findOneById(visitorId);\n\t\t}\n\n\t\tsendMessage.message.msg = sms.body;\n\t\tsendMessage.guest = visitor;\n\n\t\tsendMessage.message.attachments = sms.media.map(curr => {\n\t\t\tconst attachment = {\n\t\t\t\tmessage_link: curr.url\n\t\t\t};\n\n\t\t\tconst contentType = curr.contentType;\n\t\t\tswitch (contentType.substr(0, contentType.indexOf('/'))) {\n\t\t\t\tcase 'image':\n\t\t\t\t\tattachment.image_url = curr.url;\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'video':\n\t\t\t\t\tattachment.video_url = curr.url;\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'audio':\n\t\t\t\t\tattachment.audio_url = curr.url;\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\treturn attachment;\n\t\t});\n\n\t\ttry {\n\t\t\tconst message = SMSService.response.call(this, RocketChat.Livechat.sendMessage(sendMessage));\n\n\t\t\tMeteor.defer(() => {\n\t\t\t\tif (sms.extra) {\n\t\t\t\t\tif (sms.extra.fromCountry) {\n\t\t\t\t\t\tMeteor.call('livechat:setCustomField', sendMessage.message.token, 'country', sms.extra.fromCountry);\n\t\t\t\t\t}\n\t\t\t\t\tif (sms.extra.fromState) {\n\t\t\t\t\t\tMeteor.call('livechat:setCustomField', sendMessage.message.token, 'state', sms.extra.fromState);\n\t\t\t\t\t}\n\t\t\t\t\tif (sms.extra.fromCity) {\n\t\t\t\t\t\tMeteor.call('livechat:setCustomField', sendMessage.message.token, 'city', sms.extra.fromCity);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\n\t\t\treturn message;\n\t\t} catch (e) {\n\t\t\treturn SMSService.error.call(this, e);\n\t\t}\n\t}\n});\n","import _ from 'underscore';\n\nRocketChat.API.v1.addRoute('livechat/users/:type', { authRequired: true }, {\n\tget() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\ttype: String\n\t\t\t});\n\n\t\t\tlet role;\n\t\t\tif (this.urlParams.type === 'agent') {\n\t\t\t\trole = 'livechat-agent';\n\t\t\t} else if (this.urlParams.type === 'manager') {\n\t\t\t\trole = 'livechat-manager';\n\t\t\t} else {\n\t\t\t\tthrow 'Invalid type';\n\t\t\t}\n\n\t\t\tconst users = RocketChat.authz.getUsersInRole(role);\n\n\t\t\treturn RocketChat.API.v1.success({\n\t\t\t\tusers: users.fetch().map(user => _.pick(user, '_id', 'username', 'name', 'status', 'statusLivechat'))\n\t\t\t});\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t},\n\tpost() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\ttype: String\n\t\t\t});\n\n\t\t\tcheck(this.bodyParams, {\n\t\t\t\tusername: String\n\t\t\t});\n\n\t\t\tif (this.urlParams.type === 'agent') {\n\t\t\t\tconst user = RocketChat.Livechat.addAgent(this.bodyParams.username);\n\t\t\t\tif (user) {\n\t\t\t\t\treturn RocketChat.API.v1.success({ user });\n\t\t\t\t}\n\t\t\t} else if (this.urlParams.type === 'manager') {\n\t\t\t\tconst user = RocketChat.Livechat.addManager(this.bodyParams.username);\n\t\t\t\tif (user) {\n\t\t\t\t\treturn RocketChat.API.v1.success({ user });\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tthrow 'Invalid type';\n\t\t\t}\n\n\t\t\treturn RocketChat.API.v1.failure();\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t}\n});\n\nRocketChat.API.v1.addRoute('livechat/users/:type/:_id', { authRequired: true }, {\n\tget() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\ttype: String,\n\t\t\t\t_id: String\n\t\t\t});\n\n\t\t\tconst user = RocketChat.models.Users.findOneById(this.urlParams._id);\n\n\t\t\tif (!user) {\n\t\t\t\treturn RocketChat.API.v1.failure('User not found');\n\t\t\t}\n\n\t\t\tlet role;\n\n\t\t\tif (this.urlParams.type === 'agent') {\n\t\t\t\trole = 'livechat-agent';\n\t\t\t} else if (this.urlParams.type === 'manager') {\n\t\t\t\trole = 'livechat-manager';\n\t\t\t} else {\n\t\t\t\tthrow 'Invalid type';\n\t\t\t}\n\n\t\t\tif (user.roles.indexOf(role) !== -1) {\n\t\t\t\treturn RocketChat.API.v1.success({\n\t\t\t\t\tuser: _.pick(user, '_id', 'username')\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn RocketChat.API.v1.success({\n\t\t\t\tuser: null\n\t\t\t});\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t},\n\tdelete() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\ttype: String,\n\t\t\t\t_id: String\n\t\t\t});\n\n\t\t\tconst user = RocketChat.models.Users.findOneById(this.urlParams._id);\n\n\t\t\tif (!user) {\n\t\t\t\treturn RocketChat.API.v1.failure();\n\t\t\t}\n\n\t\t\tif (this.urlParams.type === 'agent') {\n\t\t\t\tif (RocketChat.Livechat.removeAgent(user.username)) {\n\t\t\t\t\treturn RocketChat.API.v1.success();\n\t\t\t\t}\n\t\t\t} else if (this.urlParams.type === 'manager') {\n\t\t\t\tif (RocketChat.Livechat.removeManager(user.username)) {\n\t\t\t\t\treturn RocketChat.API.v1.success();\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tthrow 'Invalid type';\n\t\t\t}\n\n\t\t\treturn RocketChat.API.v1.failure();\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t}\n});\n","import LivechatVisitors from '../../../server/models/LivechatVisitors';\n\nRocketChat.API.v1.addRoute('livechat/visitor/:visitorToken', { authRequired: true }, {\n\tget() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\tconst visitor = LivechatVisitors.getVisitorByToken(this.urlParams.visitorToken);\n\t\treturn RocketChat.API.v1.success(visitor);\n\t}\n});\n\nRocketChat.API.v1.addRoute('livechat/visitor/:visitorToken/room', { authRequired: true }, {\n\tget() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\tconst rooms = RocketChat.models.Rooms.findOpenByVisitorToken(this.urlParams.visitorToken, {\n\t\t\tfields: {\n\t\t\t\tname: 1,\n\t\t\t\tt: 1,\n\t\t\t\tcl: 1,\n\t\t\t\tu: 1,\n\t\t\t\tusernames: 1,\n\t\t\t\tservedBy: 1\n\t\t\t}\n\t\t}).fetch();\n\t\treturn RocketChat.API.v1.success({ rooms });\n\t}\n});\n"]}